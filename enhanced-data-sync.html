<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام مزامنة البيانات المحسن - آل سعيدان</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .sync-status {
            transition: all 0.3s ease;
        }
        .sync-success {
            background: linear-gradient(45deg, #10b981, #34d399);
        }
        .sync-warning {
            background: linear-gradient(45deg, #f59e0b, #fbbf24);
        }
        .sync-error {
            background: linear-gradient(45deg, #ef4444, #f87171);
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .grid { grid-template-columns: 1fr !important; }
            .text-base { font-size: 0.9rem; }
            .p-6 { padding: 1rem; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-4">
                <i class="fas fa-sync-alt mr-3 pulse-animation"></i>
                نظام مزامنة البيانات المحسن
            </h1>
            <p class="text-white text-lg opacity-90">
                حل شامل لمزامنة البيانات بين الأجهزة المختلفة
            </p>
        </div>

        <!-- حالة النظام -->
        <div id="systemStatus" class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i id="statusIcon" class="fas fa-circle-notch fa-spin text-blue-600 mr-3"></i>
                حالة النظام
            </h3>
            <div id="statusMessage" class="text-gray-700 text-base">
                جاري تحليل البيانات...
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- البيانات الحالية -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-desktop text-blue-600 mr-2"></i>
                    البيانات الحالية
                </h3>
                
                <div id="currentData" class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>أعضاء العائلة:</span>
                        <span id="currentFamilyCount" class="font-bold text-blue-600">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>الأحداث:</span>
                        <span id="currentEventsCount" class="font-bold text-green-600">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>الاقتراحات:</span>
                        <span id="currentSuggestionsCount" class="font-bold text-yellow-600">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>المكتبة:</span>
                        <span id="currentLibraryCount" class="font-bold text-purple-600">--</span>
                    </div>
                </div>
            </div>

            <!-- البيانات المتزامنة -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-cloud text-green-600 mr-2"></i>
                    البيانات المتزامنة
                </h3>
                
                <div id="syncedData" class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>أعضاء العائلة:</span>
                        <span id="syncedFamilyCount" class="font-bold text-blue-600">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>الأحداث:</span>
                        <span id="syncedEventsCount" class="font-bold text-green-600">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>الاقتراحات:</span>
                        <span id="syncedSuggestionsCount" class="font-bold text-yellow-600">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>المكتبة:</span>
                        <span id="syncedLibraryCount" class="font-bold text-purple-600">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- أدوات المزامنة -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-tools text-orange-600 mr-2"></i>
                أدوات المزامنة
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <button id="syncBtn" onclick="performDataSync()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>
                    مزامنة فورية
                </button>
                
                <button id="backupBtn" onclick="createManualBackup()" 
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    <i class="fas fa-save mr-2"></i>
                    إنشاء نسخة احتياطية
                </button>
                
                <button id="restoreBtn" onclick="restoreFromBackup()" 
                        class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    <i class="fas fa-undo mr-2"></i>
                    استرجاع البيانات
                </button>
                
                <button id="resetBtn" onclick="resetAllData()" 
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    <i class="fas fa-trash mr-2"></i>
                    إعادة تعيين
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="exportData()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    <i class="fas fa-download mr-2"></i>
                    تصدير البيانات
                </button>
                
                <label class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors cursor-pointer text-center block">
                    <i class="fas fa-upload mr-2"></i>
                    استيراد البيانات
                    <input type="file" id="importFile" accept=".json" class="hidden" onchange="importData(event)">
                </label>
            </div>
        </div>

        <!-- سجل العمليات -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-list text-gray-600 mr-2"></i>
                سجل العمليات
            </h3>
            <div id="operationsLog" class="bg-gray-50 rounded p-4 h-48 overflow-y-auto text-sm">
                <div class="text-gray-500 italic">سيتم عرض العمليات هنا...</div>
            </div>
        </div>

        <!-- العودة للتطبيق -->
        <div class="text-center mt-8">
            <a href="index.html" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-6 rounded-lg transition-colors inline-block">
                <i class="fas fa-arrow-right mr-2"></i>
                العودة للتطبيق الرئيسي
            </a>
        </div>
    </div>

    <script>
        // نظام مزامنة البيانات المحسن
        class EnhancedDataSyncSystem {
            constructor() {
                this.logContainer = document.getElementById('operationsLog');
                this.statusIcon = document.getElementById('statusIcon');
                this.statusMessage = document.getElementById('statusMessage');
                this.statusContainer = document.getElementById('systemStatus');
                
                // مفاتيح التخزين المختلفة
                this.storageKeys = {
                    main: 'saedan_family_data',
                    backup: 'family_data_backup',
                    sync: 'family_data_sync',
                    export: 'family_data_export'
                };

                this.init();
            }

            init() {
                this.log('🚀 بدء نظام المزامنة المحسن...');
                this.analyzeDataSources();
                this.updateDisplay();
                this.startPeriodicSync();
            }

            // تحليل مصادر البيانات المختلفة
            analyzeDataSources() {
                const sources = {
                    localStorage_main: this.getStorageData('localStorage', this.storageKeys.main),
                    localStorage_backup: this.getStorageData('localStorage', this.storageKeys.backup),
                    sessionStorage_main: this.getStorageData('sessionStorage', this.storageKeys.main),
                    sessionStorage_backup: this.getStorageData('sessionStorage', this.storageKeys.backup)
                };

                this.log('📊 تحليل مصادر البيانات:');
                
                let bestSource = null;
                let maxFamilyCount = 0;

                Object.keys(sources).forEach(key => {
                    const data = sources[key];
                    const count = data ? (data.familyMembers?.length || 0) : 0;
                    this.log(`   - ${key}: ${count} عضو عائلة`);
                    
                    if (count > maxFamilyCount) {
                        maxFamilyCount = count;
                        bestSource = { key, data };
                    }
                });

                if (bestSource && maxFamilyCount > 0) {
                    this.log(`✅ أفضل مصدر بيانات: ${bestSource.key} (${maxFamilyCount} عضو)`);
                    this.syncAllSources(bestSource.data);
                    this.updateStatus('success', `تم العثور على ${maxFamilyCount} عضو عائلة - البيانات متزامنة`);
                } else {
                    this.log('⚠️ لم يتم العثور على بيانات - تحميل بيانات افتراضية');
                    this.loadDefaultData();
                    this.updateStatus('warning', 'لم يتم العثور على بيانات - تم تحميل بيانات افتراضية');
                }
            }

            // الحصول على البيانات من مصدر تخزين محدد
            getStorageData(storageType, key) {
                try {
                    const storage = storageType === 'localStorage' ? localStorage : sessionStorage;
                    const dataStr = storage.getItem(key);
                    if (dataStr) {
                        const parsed = JSON.parse(dataStr);
                        return parsed.data || parsed; // دعم هياكل البيانات المختلفة
                    }
                } catch (error) {
                    this.log(`❌ خطأ في قراءة ${storageType}.${key}: ${error.message}`);
                }
                return null;
            }

            // مزامنة جميع مصادر التخزين
            syncAllSources(masterData) {
                try {
                    const syncData = {
                        data: masterData,
                        timestamp: new Date().toISOString(),
                        version: '2.0',
                        device: this.getDeviceInfo(),
                        source: 'enhanced_sync_system'
                    };

                    // حفظ في جميع مصادر التخزين
                    localStorage.setItem(this.storageKeys.main, JSON.stringify(masterData));
                    localStorage.setItem(this.storageKeys.backup, JSON.stringify(syncData));
                    sessionStorage.setItem(this.storageKeys.main, JSON.stringify(masterData));
                    sessionStorage.setItem(this.storageKeys.backup, JSON.stringify(syncData));

                    // محاولة حفظ في IndexedDB
                    this.saveToIndexedDB(syncData);

                    this.log('✅ تم مزامنة جميع مصادر التخزين بنجاح');
                    return true;
                } catch (error) {
                    this.log(`❌ خطأ في المزامنة: ${error.message}`);
                    return false;
                }
            }

            // تحميل البيانات الافتراضية
            loadDefaultData() {
                const defaultData = {
                    familyMembers: [
                        {
                            id: 1,
                            full_name: "سلمان عبدالله سعيدان",
                            generation: 1,
                            gender: "ذكر",
                            birth_year: 1975,
                            children_ids: [],
                            father_id: null,
                            mother_id: null,
                            phone: "+966533361154",
                            email: "info@salmansaedan.com",
                            occupation: "مطور عقاري"
                        }
                    ],
                    events: [],
                    suggestions: [],
                    library: []
                };

                this.syncAllSources(defaultData);
                this.log('📥 تم تحميل البيانات الافتراضية');
            }

            // الحصول على معلومات الجهاز
            getDeviceInfo() {
                return {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    screenWidth: window.screen.width,
                    screenHeight: window.screen.height,
                    deviceType: window.innerWidth <= 768 ? 'mobile' : 'desktop'
                };
            }

            // حفظ في IndexedDB
            async saveToIndexedDB(data) {
                try {
                    const request = indexedDB.open('AlSaedanFamilyDB', 1);
                    
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('familyData')) {
                            db.createObjectStore('familyData', { keyPath: 'id' });
                        }
                    };

                    request.onsuccess = (e) => {
                        const db = e.target.result;
                        const tx = db.transaction(['familyData'], 'readwrite');
                        const store = tx.objectStore('familyData');
                        store.put({ id: 'main_sync', ...data });
                        this.log('💾 تم حفظ البيانات في IndexedDB');
                    };
                } catch (error) {
                    this.log(`⚠️ لا يمكن حفظ البيانات في IndexedDB: ${error.message}`);
                }
            }

            // تحديث العرض
            updateDisplay() {
                const currentData = this.getStorageData('localStorage', this.storageKeys.main) || {};
                const syncData = this.getStorageData('localStorage', this.storageKeys.backup);
                
                // البيانات الحالية
                document.getElementById('currentFamilyCount').textContent = currentData.familyMembers?.length || 0;
                document.getElementById('currentEventsCount').textContent = currentData.events?.length || 0;
                document.getElementById('currentSuggestionsCount').textContent = currentData.suggestions?.length || 0;
                document.getElementById('currentLibraryCount').textContent = currentData.library?.length || 0;

                // البيانات المتزامنة
                if (syncData && syncData.data) {
                    document.getElementById('syncedFamilyCount').textContent = syncData.data.familyMembers?.length || 0;
                    document.getElementById('syncedEventsCount').textContent = syncData.data.events?.length || 0;
                    document.getElementById('syncedSuggestionsCount').textContent = syncData.data.suggestions?.length || 0;
                    document.getElementById('syncedLibraryCount').textContent = syncData.data.library?.length || 0;
                }
            }

            // تحديث حالة النظام
            updateStatus(type, message) {
                this.statusContainer.className = `bg-white rounded-lg shadow-lg p-6 mb-8 sync-${type}`;
                
                const icons = {
                    success: 'fas fa-check-circle text-green-600',
                    warning: 'fas fa-exclamation-triangle text-yellow-600',
                    error: 'fas fa-times-circle text-red-600',
                    loading: 'fas fa-circle-notch fa-spin text-blue-600'
                };

                this.statusIcon.className = icons[type] + ' mr-3';
                this.statusMessage.textContent = message;
            }

            // بدء المزامنة الدورية
            startPeriodicSync() {
                setInterval(() => {
                    this.analyzeDataSources();
                    this.updateDisplay();
                }, 30000); // كل 30 ثانية

                this.log('🔄 بدء المزامنة التلقائية (كل 30 ثانية)');
            }

            // تسجيل العمليات
            log(message) {
                const timestamp = new Date().toLocaleTimeString('ar-SA');
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
                
                this.logContainer.insertBefore(logEntry, this.logContainer.firstChild);
                
                // الاحتفاظ بآخر 50 عملية فقط
                while (this.logContainer.children.length > 50) {
                    this.logContainer.removeChild(this.logContainer.lastChild);
                }
            }
        }

        // إنشاء النظام
        const syncSystem = new EnhancedDataSyncSystem();

        // دوال التفاعل
        function performDataSync() {
            syncSystem.log('🔄 بدء مزامنة يدوية...');
            syncSystem.updateStatus('loading', 'جاري المزامنة...');
            
            setTimeout(() => {
                syncSystem.analyzeDataSources();
                syncSystem.updateDisplay();
                syncSystem.updateStatus('success', 'تمت المزامنة بنجاح');
            }, 1000);
        }

        function createManualBackup() {
            syncSystem.log('💾 إنشاء نسخة احتياطية يدوية...');
            const currentData = syncSystem.getStorageData('localStorage', syncSystem.storageKeys.main);
            
            if (currentData) {
                syncSystem.syncAllSources(currentData);
                syncSystem.log('✅ تم إنشاء النسخة الاحتياطية');
                syncSystem.updateStatus('success', 'تم إنشاء النسخة الاحتياطية');
            } else {
                syncSystem.log('❌ لا توجد بيانات لإنشاء نسخة احتياطية');
                syncSystem.updateStatus('error', 'لا توجد بيانات لإنشاء نسخة احتياطية');
            }
        }

        function restoreFromBackup() {
            syncSystem.log('🔄 استرجاع البيانات من النسخة الاحتياطية...');
            const backupData = syncSystem.getStorageData('localStorage', syncSystem.storageKeys.backup);
            
            if (backupData && backupData.data) {
                syncSystem.syncAllSources(backupData.data);
                syncSystem.updateDisplay();
                syncSystem.log('✅ تم استرجاع البيانات بنجاح');
                syncSystem.updateStatus('success', 'تم استرجاع البيانات من النسخة الاحتياطية');
            } else {
                syncSystem.log('❌ لا توجد نسخة احتياطية صالحة');
                syncSystem.updateStatus('error', 'لا توجد نسخة احتياطية صالحة');
            }
        }

        function resetAllData() {
            if (confirm('هل أنت متأكد من حذف جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                syncSystem.log('🗑️ حذف جميع البيانات...');
                
                // مسح جميع مصادر التخزين
                Object.values(syncSystem.storageKeys).forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });

                syncSystem.loadDefaultData();
                syncSystem.updateDisplay();
                syncSystem.log('✅ تم إعادة تعيين البيانات');
                syncSystem.updateStatus('warning', 'تم إعادة تعيين البيانات وتحميل البيانات الافتراضية');
            }
        }

        function exportData() {
            const data = syncSystem.getStorageData('localStorage', syncSystem.storageKeys.main);
            if (data) {
                const exportData = {
                    data: data,
                    timestamp: new Date().toISOString(),
                    version: '2.0',
                    source: 'manual_export'
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `al-saedan-family-data-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                syncSystem.log('📥 تم تصدير البيانات بنجاح');
                syncSystem.updateStatus('success', 'تم تصدير البيانات بنجاح');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        const data = importedData.data || importedData;
                        
                        if (data.familyMembers && Array.isArray(data.familyMembers)) {
                            syncSystem.syncAllSources(data);
                            syncSystem.updateDisplay();
                            syncSystem.log(`✅ تم استيراد ${data.familyMembers.length} عضو عائلة`);
                            syncSystem.updateStatus('success', `تم استيراد البيانات بنجاح (${data.familyMembers.length} عضو)`);
                        } else {
                            throw new Error('تنسيق البيانات غير صحيح');
                        }
                    } catch (error) {
                        syncSystem.log(`❌ خطأ في استيراد البيانات: ${error.message}`);
                        syncSystem.updateStatus('error', 'خطأ في استيراد البيانات - تحقق من صيغة الملف');
                    }
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>