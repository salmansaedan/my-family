<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار مزامنة البيانات - آل سعيدان</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-white text-center mb-8">
            <i class="fas fa-sync-alt mr-2"></i>
            اختبار مزامنة البيانات
        </h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- الجهاز الحالي -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-desktop text-blue-600 mr-2"></i>
                    البيانات المحلية (هذا الجهاز)
                </h3>
                
                <div id="localData" class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>أعضاء العائلة:</span>
                        <span id="localFamilyCount" class="font-bold text-blue-600">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>الأحداث:</span>
                        <span id="localEventsCount" class="font-bold text-green-600">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>الاقتراحات:</span>
                        <span id="localSuggestionsCount" class="font-bold text-yellow-600">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>المكتبة:</span>
                        <span id="localLibraryCount" class="font-bold text-purple-600">--</span>
                    </div>
                </div>
                
                <div class="mt-6 space-y-3">
                    <button onclick="loadLocalData()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                        <i class="fas fa-refresh mr-2"></i>تحديث البيانات المحلية
                    </button>
                    <button onclick="openMainApp()" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
                        <i class="fas fa-external-link-alt mr-2"></i>فتح التطبيق الأساسي
                    </button>
                </div>
            </div>
            
            <!-- النسخة الاحتياطية -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-cloud text-indigo-600 mr-2"></i>
                    النسخة الاحتياطية
                </h3>
                
                <div id="backupData" class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>أعضاء العائلة:</span>
                        <span id="backupFamilyCount" class="font-bold text-blue-600">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>الأحداث:</span>
                        <span id="backupEventsCount" class="font-bold text-green-600">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>الاقتراحات:</span>
                        <span id="backupSuggestionsCount" class="font-bold text-yellow-600">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span>المكتبة:</span>
                        <span id="backupLibraryCount" class="font-bold text-purple-600">--</span>
                    </div>
                    <div class="p-3 bg-blue-50 rounded">
                        <div class="text-sm text-gray-600">آخر تحديث:</div>
                        <div id="backupDate" class="font-medium text-blue-800">--</div>
                    </div>
                </div>
                
                <div class="mt-6 space-y-3">
                    <button onclick="loadBackupData()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700">
                        <i class="fas fa-cloud-download-alt mr-2"></i>تحديث بيانات النسخة الاحتياطية
                    </button>
                    <button onclick="compareData()" class="w-full bg-yellow-600 text-white py-2 px-4 rounded hover:bg-yellow-700">
                        <i class="fas fa-balance-scale mr-2"></i>مقارنة البيانات
                    </button>
                </div>
            </div>
        </div>
        
        <!-- نتائج المقارنة -->
        <div id="comparisonResult" class="bg-white rounded-lg shadow-lg p-6 mt-8 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-chart-bar text-orange-600 mr-2"></i>
                نتيجة المقارنة
            </h3>
            <div id="comparisonContent"></div>
        </div>
        
        <!-- أدوات الاختبار -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-tools text-gray-600 mr-2"></i>
                أدوات الاختبار والإدارة
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="createTestBackup()" class="bg-green-600 text-white py-3 px-4 rounded hover:bg-green-700">
                    <i class="fas fa-save mr-2"></i>إنشاء نسخة احتياطية
                </button>
                <button onclick="clearAllData()" class="bg-red-600 text-white py-3 px-4 rounded hover:bg-red-700">
                    <i class="fas fa-trash mr-2"></i>مسح جميع البيانات
                </button>
                <button onclick="exportBackup()" class="bg-purple-600 text-white py-3 px-4 rounded hover:bg-purple-700">
                    <i class="fas fa-file-export mr-2"></i>تصدير النسخة الاحتياطية
                </button>
            </div>
        </div>
        
        <!-- تعليمات -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mt-8">
            <h4 class="font-bold text-blue-800 mb-3">📋 كيفية اختبار مزامنة البيانات:</h4>
            <ol class="text-blue-700 space-y-2">
                <li class="flex items-start">
                    <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-2 mt-0.5">1</span>
                    <span>افتح التطبيق الأساسي من جهاز أو متصفح</span>
                </li>
                <li class="flex items-start">
                    <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-2 mt-0.5">2</span>
                    <span>قم بإضافة أو تعديل بعض البيانات (أعضاء عائلة، أحداث، إلخ)</span>
                </li>
                <li class="flex items-start">
                    <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-2 mt-0.5">3</span>
                    <span>افتح هذه الصفحة من جهاز أو متصفح مختلف</span>
                </li>
                <li class="flex items-start">
                    <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-2 mt-0.5">4</span>
                    <span>اضغط على "تحديث البيانات" وقارن النتائج</span>
                </li>
                <li class="flex items-start">
                    <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-2 mt-0.5">5</span>
                    <span>استخدم أدوات المقارنة لمعرفة الاختلافات</span>
                </li>
            </ol>
        </div>
    </div>

    <script>
        let localDataCache = {};
        let backupDataCache = {};

        function loadLocalData() {
            try {
                const familyData = JSON.parse(localStorage.getItem('al_saedan_family_data_v2') || '{"familyMembers":[],"events":[],"suggestions":[],"library":[]}');
                
                localDataCache = {
                    family: familyData.familyMembers?.length || 0,
                    events: familyData.events?.length || 0,
                    suggestions: familyData.suggestions?.length || 0,
                    library: familyData.library?.length || 0
                };
                
                document.getElementById('localFamilyCount').textContent = localDataCache.family;
                document.getElementById('localEventsCount').textContent = localDataCache.events;
                document.getElementById('localSuggestionsCount').textContent = localDataCache.suggestions;
                document.getElementById('localLibraryCount').textContent = localDataCache.library;
                
                console.log('تم تحديث البيانات المحلية:', localDataCache);
            } catch (error) {
                console.error('خطأ في قراءة البيانات المحلية:', error);
                alert('خطأ في قراءة البيانات المحلية: ' + error.message);
            }
        }

        function loadBackupData() {
            try {
                const backupStr = localStorage.getItem('family_data_backup');
                if (backupStr) {
                    const backup = JSON.parse(backupStr);
                    
                    backupDataCache = {
                        family: backup.data?.familyMembers?.length || 0,
                        events: backup.data?.events?.length || 0,
                        suggestions: backup.data?.suggestions?.length || 0,
                        library: backup.data?.library?.length || 0,
                        date: backup.timestamp
                    };
                    
                    document.getElementById('backupFamilyCount').textContent = backupDataCache.family;
                    document.getElementById('backupEventsCount').textContent = backupDataCache.events;
                    document.getElementById('backupSuggestionsCount').textContent = backupDataCache.suggestions;
                    document.getElementById('backupLibraryCount').textContent = backupDataCache.library;
                    document.getElementById('backupDate').textContent = new Date(backupDataCache.date).toLocaleString('ar-SA');
                } else {
                    document.getElementById('backupFamilyCount').textContent = '0';
                    document.getElementById('backupEventsCount').textContent = '0';
                    document.getElementById('backupSuggestionsCount').textContent = '0';
                    document.getElementById('backupLibraryCount').textContent = '0';
                    document.getElementById('backupDate').textContent = 'غير متوفرة';
                }
                
                console.log('تم تحديث بيانات النسخة الاحتياطية:', backupDataCache);
            } catch (error) {
                console.error('خطأ في قراءة النسخة الاحتياطية:', error);
                alert('خطأ في قراءة النسخة الاحتياطية: ' + error.message);
            }
        }

        function compareData() {
            const result = document.getElementById('comparisonResult');
            const content = document.getElementById('comparisonContent');
            
            let comparison = '<div class="grid grid-cols-1 md:grid-cols-4 gap-4">';
            
            const categories = [
                { key: 'family', name: 'العائلة', icon: 'fas fa-users' },
                { key: 'events', name: 'الأحداث', icon: 'fas fa-calendar' },
                { key: 'suggestions', name: 'الاقتراحات', icon: 'fas fa-lightbulb' },
                { key: 'library', name: 'المكتبة', icon: 'fas fa-book' }
            ];
            
            categories.forEach(cat => {
                const local = localDataCache[cat.key] || 0;
                const backup = backupDataCache[cat.key] || 0;
                const diff = local - backup;
                
                let statusClass = 'bg-green-50 border-green-200';
                let statusIcon = 'fas fa-check text-green-600';
                let statusText = 'متطابق';
                
                if (diff !== 0) {
                    statusClass = 'bg-yellow-50 border-yellow-200';
                    statusIcon = 'fas fa-exclamation-triangle text-yellow-600';
                    statusText = `فرق: ${diff > 0 ? '+' : ''}${diff}`;
                }
                
                comparison += `
                    <div class="card p-4 ${statusClass}">
                        <div class="text-center">
                            <i class="${cat.icon} text-2xl text-gray-700 mb-2"></i>
                            <h5 class="font-bold text-gray-800">${cat.name}</h5>
                            <div class="mt-2 space-y-1">
                                <div class="text-sm">محلي: <span class="font-bold">${local}</span></div>
                                <div class="text-sm">احتياطي: <span class="font-bold">${backup}</span></div>
                                <div class="flex items-center justify-center mt-2">
                                    <i class="${statusIcon} mr-1"></i>
                                    <span class="text-xs font-medium">${statusText}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            comparison += '</div>';
            content.innerHTML = comparison;
            result.classList.remove('hidden');
        }

        function createTestBackup() {
            try {
                const testData = {
                    data: JSON.parse(localStorage.getItem('al_saedan_family_data_v2') || '{"familyMembers":[],"events":[],"suggestions":[],"library":[]}'),
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    source: 'manual_backup_test'
                };
                
                localStorage.setItem('family_data_backup', JSON.stringify(testData));
                alert('✅ تم إنشاء نسخة احتياطية يدوية بنجاح!');
                loadBackupData();
            } catch (error) {
                console.error('خطأ في إنشاء النسخة الاحتياطية:', error);
                alert('❌ خطأ في إنشاء النسخة الاحتياطية: ' + error.message);
            }
        }

        function clearAllData() {
            if (confirm('هل أنت متأكد من مسح جميع البيانات؟\\nسيتم حذف البيانات المحلية والنسخة الاحتياطية!')) {
                localStorage.removeItem('al_saedan_family_data_v2');
                localStorage.removeItem('family_data_backup');
                sessionStorage.clear();
                
                alert('✅ تم مسح جميع البيانات');
                loadLocalData();
                loadBackupData();
            }
        }

        function exportBackup() {
            try {
                const backupStr = localStorage.getItem('family_data_backup');
                if (!backupStr) {
                    alert('⚠️ لا توجد نسخة احتياطية للتصدير');
                    return;
                }
                
                const dataBlob = new Blob([backupStr], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `family_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                alert('✅ تم تصدير النسخة الاحتياطية بنجاح!');
            } catch (error) {
                console.error('خطأ في التصدير:', error);
                alert('❌ خطأ في التصدير: ' + error.message);
            }
        }

        function openMainApp() {
            window.open('/index.html', '_blank');
        }

        // تحميل البيانات عند فتح الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            loadLocalData();
            loadBackupData();
            
            // تحديث تلقائي كل 30 ثانية
            setInterval(() => {
                loadLocalData();
                loadBackupData();
            }, 30000);
        });
    </script>
</body>
</html>