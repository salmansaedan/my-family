<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق آل سعيدان الشامل - مع الأجيال المترابطة</title>
    
    <!-- CSS Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet" />
    
    <!-- Arabic Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    
    <!-- Chart.js for Statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { 
            font-family: 'Noto Sans Arabic', Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #3b82f6, #10b981);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        .section { display: none; }
        .section.active { display: block; }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        .card:hover {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .modal { backdrop-filter: blur(5px); }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #10b981);
            transition: all 0.3s;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #059669);
            transform: translateY(-1px);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { background: linear-gradient(135deg, #10b981, #059669); }
        .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .toast.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }

        /* إصلاح مشكلة الرسوم البيانية */
        canvas {
            max-height: 300px !important;
            width: 100% !important;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            overflow: hidden;
        }

        /* تصميم الشجرة العائلية المحسن */
        .generation {
            margin-bottom: 40px;
            border-left: 4px solid #3b82f6;
            padding-left: 25px;
            position: relative;
        }
        
        .generation::before {
            content: '';
            position: absolute;
            left: -2px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #3b82f6, #10b981);
        }
        
        .generation-header {
            background: linear-gradient(135deg, #3b82f6, #10b981);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .member-card {
            margin: 15px 0;
            border-right: 3px solid #10b981;
            padding-right: 20px;
            position: relative;
        }
        
        .founder-card {
            border-right: 3px solid #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(59, 130, 246, 0.05));
        }
        
        .connection-line {
            border-left: 2px dashed #cbd5e1;
            margin-right: 25px;
            padding-left: 25px;
            position: relative;
        }
        
        .connection-line::before {
            content: '↳';
            position: absolute;
            left: -15px;
            top: 20px;
            color: #3b82f6;
            font-size: 18px;
            font-weight: bold;
        }

        .member-actions {
            position: absolute;
            top: 15px;
            left: 15px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .member-card:hover .member-actions {
            opacity: 1;
        }
        
        .edit-btn, .delete-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 8px;
            margin: 2px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .edit-btn:hover { background: #3b82f6; color: white; }
        .delete-btn:hover { background: #ef4444; color: white; }

        /* تحسين الإحصائيات */
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .stat-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-800 ml-4">
                        <i class="fas fa-home text-blue-600 ml-2"></i>
                        تطبيق آل سعيدان الشامل
                    </h1>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-8 rtl:space-x-reverse">
                    <!-- Navigation Items (shown when logged in) -->
                    <div id="mainNavigation" class="flex space-x-8 rtl:space-x-reverse">
                        <button id="nav-home" class="nav-item active px-4 py-2 rounded-lg transition" onclick="showSection('home')">
                            <i class="fas fa-home ml-2"></i>الرئيسية
                        </button>
                        <button id="nav-family" class="nav-item px-4 py-2 rounded-lg transition" onclick="showSection('family')">
                            <i class="fas fa-users ml-2"></i>الشجرة العائلية
                        </button>
                        <button id="nav-events" class="nav-item px-4 py-2 rounded-lg transition" onclick="showSection('events')">
                            <i class="fas fa-calendar ml-2"></i>الأحداث
                        </button>
                        <button id="nav-suggestions" class="nav-item px-4 py-2 rounded-lg transition" onclick="showSection('suggestions')">
                            <i class="fas fa-lightbulb ml-2"></i>الاقتراحات
                        </button>
                        <button id="nav-library" class="nav-item px-4 py-2 rounded-lg transition" onclick="showSection('library')">
                            <i class="fas fa-book ml-2"></i>المكتبة الرقمية
                        </button>
                    </div>

                    <!-- User Menu -->
                    <div class="flex items-center space-x-4 rtl:space-x-reverse">
                        <!-- Admin Panel (admin only) -->
                        <button id="nav-admin" class="nav-item px-4 py-2 rounded-lg transition bg-red-100 text-red-700 border border-red-300 hidden" onclick="showSection('admin')">
                            <i class="fas fa-cog ml-2"></i>لوحة الإدارة
                        </button>
                        
                        <!-- User Profile -->
                        <div class="relative" id="userProfileMenu">
                            <button onclick="showSection('profile')" class="flex items-center px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition">
                                <i class="fas fa-user ml-2"></i>
                                <span id="currentUserName">الملف الشخصي</span>
                            </button>
                        </div>
                        
                        <!-- Logout -->
                        <button onclick="logout()" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition">
                            <i class="fas fa-sign-out-alt ml-2"></i>خروج
                        </button>
                    </div>
                    
                    <!-- Login/Register buttons (shown when not logged in) -->
                    <div id="authButtons" class="flex items-center space-x-4 rtl:space-x-reverse">
                        <button onclick="showLoginModal()" class="px-6 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">
                            <i class="fas fa-sign-in-alt ml-2"></i>دخول
                        </button>
                        <button onclick="showRegisterModal()" class="px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition">
                            <i class="fas fa-user-plus ml-2"></i>تسجيل جديد
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sync Status Bar -->
    <div class="bg-blue-50 border-b border-blue-200">
        <div class="max-w-7xl mx-auto px-4 py-2">
            <div id="syncStatus" class="text-center text-blue-700">
                <span class="font-medium">🔄 تطبيق آل سعيدان الشامل - مع الأجيال المترابطة</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Home Section -->
        <section id="home-section" class="section active">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Statistics Cards -->
                <div class="stat-card">
                    <i class="fas fa-users stat-icon text-blue-600"></i>
                    <div class="stat-number text-blue-600" id="total-members">0</div>
                    <p class="text-gray-600 font-medium">أعضاء العائلة</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-calendar-alt stat-icon text-green-600"></i>
                    <div class="stat-number text-green-600" id="total-events">0</div>
                    <p class="text-gray-600 font-medium">الأحداث</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-lightbulb stat-icon text-yellow-600"></i>
                    <div class="stat-number text-yellow-600" id="total-suggestions">0</div>
                    <p class="text-gray-600 font-medium">الاقتراحات</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-book stat-icon text-purple-600"></i>
                    <div class="stat-number text-purple-600" id="total-library">0</div>
                    <p class="text-gray-600 font-medium">المكتبة الرقمية</p>
                </div>
            </div>
            
            <!-- Additional Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                    <i class="fas fa-layer-group stat-icon text-indigo-600"></i>
                    <div class="stat-number text-indigo-600" id="total-generations">1</div>
                    <p class="text-gray-600 font-medium">الأجيال</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-crown stat-icon text-amber-600"></i>
                    <div class="stat-number text-amber-600" id="board-members">0</div>
                    <p class="text-gray-600 font-medium">أعضاء الإدارة</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-chart-line stat-icon text-rose-600"></i>
                    <div class="stat-number text-rose-600" id="active-events">0</div>
                    <p class="text-gray-600 font-medium">أحداث نشطة</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-thumbs-up stat-icon text-emerald-600"></i>
                    <div class="stat-number text-emerald-600" id="approved-suggestions">0</div>
                    <p class="text-gray-600 font-medium">اقتراحات مقبولة</p>
                </div>
            </div>
            
            <!-- Welcome Message -->
            <div class="card p-8 text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">مرحباً بكم في تطبيق آل سعيدان الشامل</h2>
                <p class="text-xl text-gray-600 mb-6">إدارة متكاملة للشجرة العائلية مع ربط الأجيال، الأحداث، الاقتراحات والمكتبة الرقمية</p>
                
                <div class="bg-gradient-to-r from-blue-50 to-green-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-blue-800 mb-3">
                        <i class="fas fa-sitemap ml-2"></i>
                        الميزة الجديدة: الأجيال المترابطة
                    </h3>
                    <p class="text-blue-700 font-medium mb-2">🌳 كل عضو جديد يُربط تلقائياً بالجيل السابق</p>
                    <p class="text-blue-700 font-medium mb-2">🔢 حساب تلقائي للأجيال: الجيل = جيل الوالد + 1</p>
                    <p class="text-blue-700 font-medium">👨‍👩‍👧‍👦 عرض هرمي منظم للعائلة حسب الأجيال</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="showSection('family')" class="btn-primary text-white px-8 py-4 rounded-lg text-lg">
                        <i class="fas fa-sitemap ml-2"></i>استكشف الشجرة العائلية
                    </button>
                    <button onclick="loadSampleData()" class="bg-amber-600 text-white px-8 py-4 rounded-lg text-lg hover:bg-amber-700">
                        <i class="fas fa-database ml-2"></i>تحميل البيانات الأساسية
                    </button>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">توزيع العضوية</h3>
                    <div class="chart-container">
                        <canvas id="membershipChart"></canvas>
                    </div>
                </div>
                <div class="card p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">النشاط الشهري</h3>
                    <div class="chart-container">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Family Section -->
        <section id="family-section" class="section">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-white">الشجرة العائلية بالأجيال المترابطة</h2>
                <div class="flex gap-3">
                    <button onclick="testSecondGenerationRetrieval()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700" title="اختبار استرجاع بيانات الجيل الثاني">
                        <i class="fas fa-search ml-2"></i>اختبار الجيل الثاني
                    </button>
                    <button onclick="loadFounderFamily()" class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700">
                        <i class="fas fa-crown ml-2"></i>تحميل العائلة الأساسية
                    </button>
                    <button onclick="showFamilyModal()" class="btn-primary text-white px-6 py-3 rounded-lg">
                        <i class="fas fa-plus ml-2"></i>إضافة عضو جديد
                    </button>
                </div>
            </div>
            
            <!-- حالة البيانات -->
            <div id="data-status" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-center">
                <div class="flex items-center justify-center space-x-4 rtl:space-x-reverse">
                    <div class="text-blue-700">
                        <span id="member-count-display">📊 لا توجد بيانات</span>
                    </div>
                    <div class="text-green-700">
                        <span id="generation-count-display">🌳 الأجيال: 0</span>
                    </div>
                </div>
            </div>

            <div id="family-tree" class="space-y-6">
                <!-- Family tree will be displayed here -->
            </div>
        </section>

        <!-- Events Section -->
        <section id="events-section" class="section">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-white">إدارة الأحداث</h2>
                <button onclick="showEventModal()" class="btn-primary text-white px-6 py-3 rounded-lg">
                    <i class="fas fa-plus ml-2"></i>إضافة حدث جديد
                </button>
            </div>
            
            <div id="events-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Events will be displayed here -->
            </div>
        </section>

        <!-- Suggestions Section -->
        <section id="suggestions-section" class="section">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-white">الاقتراحات والتطوير</h2>
                <button onclick="showSuggestionModal()" class="btn-primary text-white px-6 py-3 rounded-lg">
                    <i class="fas fa-plus ml-2"></i>إضافة اقتراح جديد
                </button>
            </div>

            <!-- Filter Bar -->
            <div class="card p-6 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Status Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">حالة الاقتراح</label>
                        <select id="suggestionStatusFilter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                onchange="filterSuggestionsByStatus(this.value)">
                            <option value="all">جميع الحالات</option>
                            <option value="pending">⏳ قيد المراجعة</option>
                            <option value="approved">✅ مقبول</option>
                            <option value="rejected">❌ مرفوض</option>
                            <option value="under_review">🔍 تحت المراجعة</option>
                        </select>
                    </div>

                    <!-- Category Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">الفئة</label>
                        <select id="suggestionCategoryFilter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                onchange="filterSuggestionsByCategory(this.value)">
                            <option value="all">جميع الفئات</option>
                            <option value="technology">🔧 تقني</option>
                            <option value="events">🎉 فعاليات</option>
                            <option value="services">🛎️ خدمات</option>
                            <option value="education">📚 تعليمي</option>
                            <option value="social">👥 اجتماعي</option>
                            <option value="business">💼 تجاري</option>
                            <option value="other">📝 أخرى</option>
                        </select>
                    </div>

                    <!-- Priority Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">الأولوية</label>
                        <select id="suggestionPriorityFilter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                onchange="filterSuggestionsByPriority(this.value)">
                            <option value="all">جميع الأولويات</option>
                            <option value="urgent">🚨 عاجل</option>
                            <option value="high">🔴 عالية</option>
                            <option value="medium">🟡 متوسطة</option>
                            <option value="low">🟢 منخفضة</option>
                        </select>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 pt-4 border-t border-gray-200">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="suggestions-total">0</div>
                        <p class="text-sm text-gray-600">إجمالي الاقتراحات</p>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-600" id="suggestions-pending">0</div>
                        <p class="text-sm text-gray-600">قيد المراجعة</p>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="suggestions-approved">0</div>
                        <p class="text-sm text-gray-600">مقبولة</p>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-red-600" id="suggestions-high-priority">0</div>
                        <p class="text-sm text-gray-600">أولوية عالية</p>
                    </div>
                </div>
            </div>
            
            <div id="suggestions-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Suggestions will be displayed here -->
            </div>
        </section>

        <!-- Library Section -->
        <section id="library-section" class="section">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-white">المكتبة الرقمية</h2>
                <button onclick="showLibraryModal()" class="btn-primary text-white px-6 py-3 rounded-lg">
                    <i class="fas fa-plus ml-2"></i>إضافة محتوى جديد
                </button>
            </div>

            <!-- Search and Filter Bar -->
            <div class="card p-6 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Search -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">البحث في المكتبة</label>
                        <div class="relative">
                            <input type="text" id="librarySearch" placeholder="ابحث في العناوين، الوصف، المؤلف، أو الكلمات المفتاحية..." 
                                   class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   oninput="searchLibrary(this.value)">
                            <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>

                    <!-- Category Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">فلترة حسب الفئة</label>
                        <select id="libraryCategoryFilter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                onchange="filterLibraryByCategory(this.value)">
                            <option value="all">جميع الفئات</option>
                            <option value="family_history">🏛️ تاريخ العائلة</option>
                            <option value="genealogy">🌳 الأنساب</option>
                            <option value="documents">📋 الوثائق الرسمية</option>
                            <option value="photos">📸 الصور والذكريات</option>
                            <option value="achievements">🏆 الإنجازات</option>
                            <option value="stories">📖 القصص والحكايات</option>
                            <option value="education">🎓 التعليم والمهارات</option>
                            <option value="business">💼 الأعمال والتجارة</option>
                        </select>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 pt-4 border-t border-gray-200">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="library-total-items">0</div>
                        <p class="text-sm text-gray-600">إجمالي المحتويات</p>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="library-featured-items">0</div>
                        <p class="text-sm text-gray-600">محتوى مميز</p>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600" id="library-total-views">0</div>
                        <p class="text-sm text-gray-600">إجمالي المشاهدات</p>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-orange-600" id="library-total-downloads">0</div>
                        <p class="text-sm text-gray-600">إجمالي التحميلات</p>
                    </div>
                </div>
            </div>
            
            <div id="library-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Library items will be displayed here -->
            </div>
        </section>

        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-white">الملف الشخصي</h2>
                    <button onclick="editProfile()" class="btn-primary text-white px-6 py-3 rounded-lg">
                        <i class="fas fa-edit ml-2"></i>تعديل البيانات
                    </button>
                </div>
                
                <div id="profileContent" class="space-y-6">
                    <!-- Profile content will be displayed here -->
                </div>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="admin-section" class="section">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-white">لوحة الإدارة</h2>
                <div class="flex gap-4">
                    <button onclick="refreshPendingUsers()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-refresh ml-2"></i>تحديث
                    </button>
                </div>
            </div>
            
            <!-- Pending Users Tab -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">طلبات التسجيل المعلقة</h3>
                <div id="pendingUsersGrid" class="space-y-4">
                    <!-- Pending users will be displayed here -->
                </div>
            </div>
            
            <!-- System Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">المستخدمون المفعلون</h4>
                    <div class="text-3xl font-bold text-green-600" id="activeUsersCount">0</div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">طلبات معلقة</h4>
                    <div class="text-3xl font-bold text-orange-600" id="pendingUsersCount">0</div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">إجمالي المستخدمين</h4>
                    <div class="text-3xl font-bold text-blue-600" id="totalUsersCount">0</div>
                </div>
            </div>
        </section>
    </div>

    <!-- Family Member Modal -->
    <div id="familyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal">
        <div class="bg-white p-6 rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="familyModalTitle">إضافة عضو جديد للعائلة</h3>
                <button type="button" onclick="hideFamilyModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="familyForm">
                <!-- معلومات الاسم -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                        <i class="fas fa-user ml-2"></i>بيانات الاسم
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الأول *</label>
                            <input type="text" id="familyFirstName" placeholder="مثال: أحمد" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الأوسط</label>
                            <input type="text" id="familyMiddleName" placeholder="مثال: محمد" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">اسم العائلة *</label>
                            <input type="text" id="familyLastName" placeholder="مثال: بن سعيدان" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    </div>
                    <div class="mt-3 p-2 bg-white rounded border">
                        <label class="block text-xs font-medium text-gray-500 mb-1">الاسم الكامل (معاينة)</label>
                        <div id="fullNamePreview" class="text-lg font-semibold text-gray-800">سيتم تكوين الاسم تلقائياً...</div>
                    </div>
                </div>

                <!-- معلومات الميلاد -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-green-800 mb-4 flex items-center">
                        <i class="fas fa-birthday-cake ml-2"></i>بيانات الميلاد
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ الميلاد</label>
                            <input type="date" id="familyBirthDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">مكان الميلاد</label>
                            <input type="text" id="familyBirthPlace" placeholder="مثال: الرياض، المملكة العربية السعودية" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <!-- معلومات الأجيال -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-amber-800 mb-4 flex items-center">
                        <i class="fas fa-sitemap ml-2"></i>ربط الأجيال
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الوالد/الجيل السابق</label>
                            <select id="familyFatherId" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- اختر الوالد --</option>
                            </select>
                            <p class="text-sm text-gray-500 mt-1">اختر من الجيل السابق لإنشاء الرابط العائلي</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الجيل الحالي</label>
                            <input type="text" id="familyCurrentGeneration" placeholder="سيتم حسابه تلقائياً" class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg" readonly>
                            <p class="text-sm text-green-600 mt-1">يُحسب تلقائياً بناءً على الوالد المختار</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الزوج/الزوجة (اختياري)</label>
                            <select id="familySpouseId" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- اختر الزوج/الزوجة --</option>
                            </select>
                            <p class="text-sm text-gray-500 mt-1">اختر من نفس الجيل أو جيل مقارب لإنشاء رابط الزواج</p>
                        </div>
                    </div>
                </div>

                <!-- معلومات شخصية -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                        <i class="fas fa-id-card ml-2"></i>المعلومات الشخصية
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الجنس *</label>
                            <select id="familyGender" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">-- اختر الجنس --</option>
                                <option value="male">ذكر</option>
                                <option value="female">أنثى</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">نوع العضوية *</label>
                            <select id="familyMembershipType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">-- اختر نوع العضوية --</option>
                                <option value="founder">👑 مؤسس</option>
                                <option value="chairman">🎖️ رئيس مجلس الإدارة</option>
                                <option value="board_member">👔 عضو مجلس الإدارة</option>
                                <option value="general_assembly">👥 عضو الجمعية العمومية</option>
                                <option value="family_member">👨‍👩‍👧‍👦 عضو عائلة</option>
                                <option value="honorary">🏅 عضو شرفي</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- معلومات مهنية -->
                <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-indigo-800 mb-4 flex items-center">
                        <i class="fas fa-briefcase ml-2"></i>المعلومات المهنية
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">المهنة</label>
                            <input type="text" id="familyProfession" placeholder="مثال: مهندس، طبيب، معلم" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">التخصص العملي</label>
                            <input type="text" id="familySpecialization" placeholder="مثال: هندسة الحاسوب، طب الأطفال" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <!-- معلومات الاتصال -->
                <div class="bg-teal-50 border border-teal-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-teal-800 mb-4 flex items-center">
                        <i class="fas fa-phone ml-2"></i>معلومات التواصل
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">رقم الجوال</label>
                            <input type="tel" id="familyPhone" placeholder="05xxxxxxxx" pattern="[0-9]{10}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1">يرجى إدخال رقم الجوال بصيغة 05xxxxxxxx</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">البريد الإلكتروني</label>
                            <input type="email" id="familyEmail" placeholder="example@email.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <!-- معلومات إضافية -->
                <div class="bg-rose-50 border border-rose-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-rose-800 mb-4 flex items-center">
                        <i class="fas fa-heart ml-2"></i>المعلومات الإضافية
                    </h4>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الهوايات والاهتمامات</label>
                            <textarea id="familyHobbies" rows="3" placeholder="مثال: القراءة، الرياضة، السفر، التصوير، البرمجة..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical"></textarea>
                        </div>
                    </div>
                </div>

                <!-- أزرار التحكم -->
                <div class="flex justify-end space-x-4 rtl:space-x-reverse pt-4 border-t border-gray-200">
                    <button type="button" onclick="hideFamilyModal()" class="px-8 py-3 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition font-medium">
                        <i class="fas fa-times ml-2"></i>إلغاء
                    </button>
                    <button type="button" onclick="resetFamilyForm()" class="px-8 py-3 text-amber-600 bg-amber-100 border border-amber-300 rounded-lg hover:bg-amber-200 transition font-medium">
                        <i class="fas fa-refresh ml-2"></i>إعادة تعيين
                    </button>
                    <button type="submit" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-green-600 text-white rounded-lg hover:from-blue-700 hover:to-green-700 transition font-medium shadow-lg">
                        <i class="fas fa-save ml-2"></i>حفظ العضو
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal">
        <div class="bg-white p-8 rounded-lg max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">تسجيل الدخول</h3>
                <button type="button" onclick="hideLoginModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهوية أو البريد الإلكتروني *</label>
                    <input type="text" id="loginIdentifier" placeholder="أدخل رقم الهوية أو البريد الإلكتروني" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور *</label>
                    <input type="password" id="loginPassword" placeholder="أدخل كلمة المرور" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                
                <div class="flex justify-between items-center mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="rememberMe" class="mr-2">
                        <span class="text-sm text-gray-600">تذكرني</span>
                    </label>
                    <button type="button" class="text-sm text-blue-600 hover:text-blue-800">نسيت كلمة المرور؟</button>
                </div>
                
                <div class="flex justify-end space-x-4 rtl:space-x-reverse">
                    <button type="button" onclick="hideLoginModal()" class="px-6 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                        إلغاء
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        دخول
                    </button>
                </div>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-gray-600">ليس لديك حساب؟ 
                    <button onclick="hideLoginModal(); showRegisterModal()" class="text-blue-600 hover:text-blue-800 font-medium">سجل الآن</button>
                </p>
            </div>
            
            <!-- تشخيص المدير -->
            <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                <p class="text-sm font-medium text-gray-700 mb-2">حساب المدير الافتراضي:</p>
                <div class="text-xs text-gray-600 space-y-1">
                    <div>البريد الإلكتروني: <code class="bg-gray-200 px-1 rounded">admin@salmansaedan.com</code></div>
                    <div>كلمة المرور: <code class="bg-gray-200 px-1 rounded">admin123</code></div>
                    <button onclick="resetDefaultAdmin()" class="mt-2 px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                        إعادة تعيين المدير
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal">
        <div class="bg-white p-6 rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">تسجيل عضو جديد</h3>
                <button type="button" onclick="hideRegisterModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-blue-600 ml-2"></i>
                    <div class="text-blue-800">
                        <p class="font-medium">ملاحظة هامة:</p>
                        <p class="text-sm mt-1">سيتم إرسال طلب التسجيل للمراجعة من قبل الإدارة. ستتلقى إشعاراً عند تفعيل حسابك.</p>
                    </div>
                </div>
            </div>
            
            <form id="registerForm">
                <!-- معلومات الاسم -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                        <i class="fas fa-user ml-2"></i>بيانات الاسم
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الأول *</label>
                            <input type="text" id="registerFirstName" placeholder="مثال: أحمد" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الأوسط *</label>
                            <input type="text" id="registerMiddleName" placeholder="مثال: محمد" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">اسم العائلة *</label>
                            <input type="text" id="registerLastName" placeholder="مثال: بن سعيدان" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    </div>
                    <div class="mt-3 p-2 bg-white rounded border">
                        <label class="block text-xs font-medium text-gray-500 mb-1">الاسم الكامل (معاينة)</label>
                        <div id="registerFullNamePreview" class="text-lg font-semibold text-gray-800">سيتم تكوين الاسم تلقائياً...</div>
                    </div>
                </div>

                <!-- معلومات الميلاد والهوية -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-green-800 mb-4 flex items-center">
                        <i class="fas fa-id-card ml-2"></i>البيانات الشخصية
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهوية *</label>
                            <input type="text" id="registerNationalId" placeholder="1xxxxxxxxx" pattern="[1-2][0-9]{9}" maxlength="10" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <p class="text-xs text-gray-500 mt-1">رقم الهوية السعودية (10 أرقام)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ الميلاد *</label>
                            <input type="date" id="registerBirthDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">مكان الميلاد *</label>
                            <input type="text" id="registerBirthPlace" placeholder="مثال: الرياض، المملكة العربية السعودية" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    </div>
                </div>

                <!-- معلومات الأجيال -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-amber-800 mb-4 flex items-center">
                        <i class="fas fa-sitemap ml-2"></i>ربط الأجيال
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الوالد/الجيل السابق</label>
                            <select id="registerFatherId" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- اختر الوالد (اختياري) --</option>
                            </select>
                            <p class="text-sm text-gray-500 mt-1">اختر من الجيل السابق إذا كان متاحاً</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الجيل المتوقع</label>
                            <input type="text" id="registerExpectedGeneration" placeholder="سيتم حسابه تلقائياً" class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg" readonly>
                            <p class="text-sm text-green-600 mt-1">يُحسب تلقائياً بناءً على الوالد المختار</p>
                        </div>
                    </div>
                </div>

                <!-- المعلومات المهنية والعلمية -->
                <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-indigo-800 mb-4 flex items-center">
                        <i class="fas fa-graduation-cap ml-2"></i>المعلومات المهنية والعلمية
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">المهنة *</label>
                            <input type="text" id="registerProfession" placeholder="مثال: مهندس، طبيب، معلم" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">التخصص العلمي *</label>
                            <input type="text" id="registerSpecialization" placeholder="مثال: هندسة الحاسوب، طب الأطفال" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    </div>
                </div>

                <!-- معلومات التواصل -->
                <div class="bg-teal-50 border border-teal-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-teal-800 mb-4 flex items-center">
                        <i class="fas fa-phone ml-2"></i>معلومات التواصل
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">رقم الجوال *</label>
                            <input type="tel" id="registerPhone" placeholder="05xxxxxxxx" pattern="[0-9]{10}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <p class="text-xs text-gray-500 mt-1">يرجى إدخال رقم الجوال بصيغة 05xxxxxxxx</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">البريد الإلكتروني *</label>
                            <input type="email" id="registerEmail" placeholder="example@email.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    </div>
                </div>

                <!-- الهوايات وكلمة المرور -->
                <div class="bg-rose-50 border border-rose-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-rose-800 mb-4 flex items-center">
                        <i class="fas fa-key ml-2"></i>معلومات إضافية وأمنية
                    </h4>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الهوايات والاهتمامات *</label>
                            <textarea id="registerHobbies" rows="3" placeholder="مثال: القراءة، الرياضة، السفر، التصوير، البرمجة..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical" required></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور *</label>
                                <input type="password" id="registerPassword" placeholder="أدخل كلمة مرور قوية" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <p class="text-xs text-gray-500 mt-1">8 أحرف على الأقل</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">تأكيد كلمة المرور *</label>
                                <input type="password" id="registerPasswordConfirm" placeholder="أعد إدخال كلمة المرور" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- الموافقة والشروط -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                    <label class="flex items-start">
                        <input type="checkbox" id="registerAgree" class="mt-1 mr-2" required>
                        <div class="text-sm text-gray-700">
                            <p class="font-medium">أوافق على الشروط والأحكام:</p>
                            <ul class="mt-2 space-y-1 text-xs text-gray-600">
                                <li>• جميع البيانات المدخلة صحيحة ومسؤول عنها</li>
                                <li>• سيتم مراجعة الطلب من قبل إدارة العائلة</li>
                                <li>• الالتزام بآداب وقوانين التطبيق</li>
                                <li>• عدم إساءة استخدام المنصة أو البيانات</li>
                            </ul>
                        </div>
                    </label>
                </div>

                <!-- أزرار التحكم -->
                <div class="flex justify-end space-x-4 rtl:space-x-reverse pt-4 border-t border-gray-200">
                    <button type="button" onclick="hideRegisterModal()" class="px-8 py-3 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition font-medium">
                        <i class="fas fa-times ml-2"></i>إلغاء
                    </button>
                    <button type="button" onclick="resetRegisterForm()" class="px-8 py-3 text-amber-600 bg-amber-100 border border-amber-300 rounded-lg hover:bg-amber-200 transition font-medium">
                        <i class="fas fa-refresh ml-2"></i>إعادة تعيين
                    </button>
                    <button type="submit" class="px-8 py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg hover:from-green-700 hover:to-blue-700 transition font-medium shadow-lg">
                        <i class="fas fa-user-plus ml-2"></i>إرسال طلب التسجيل
                    </button>
                </div>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-gray-600">لديك حساب بالفعل؟ 
                    <button onclick="hideRegisterModal(); showLoginModal()" class="text-blue-600 hover:text-blue-800 font-medium">سجل دخول</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Suggestion Modal -->
    <div id="suggestionModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl w-full max-w-2xl max-h-screen overflow-y-auto mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-lightbulb text-yellow-500 ml-2"></i>
                    إضافة اقتراح جديد
                </h2>
                <button onclick="hideSuggestionModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="suggestionForm" onsubmit="handleSuggestionSubmit(event)">
                <!-- معلومات الاقتراح الأساسية -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                        <i class="fas fa-info-circle ml-2"></i>معلومات الاقتراح
                    </h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">عنوان الاقتراح *</label>
                            <input type="text" id="suggestionTitle" placeholder="مثال: تطوير تطبيق الجوال" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">فئة الاقتراح *</label>
                            <select id="suggestionCategory" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">-- اختر الفئة --</option>
                                <option value="technology">🔧 تقني</option>
                                <option value="events">🎉 فعاليات</option>
                                <option value="services">🛎️ خدمات</option>
                                <option value="education">📚 تعليمي</option>
                                <option value="social">👥 اجتماعي</option>
                                <option value="business">💼 تجاري</option>
                                <option value="other">📝 أخرى</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الأولوية</label>
                            <select id="suggestionPriority" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="low">🟢 منخفضة</option>
                                <option value="medium" selected>🟡 متوسطة</option>
                                <option value="high">🔴 عالية</option>
                                <option value="urgent">🚨 عاجل</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- وصف تفصيلي -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-green-800 mb-4 flex items-center">
                        <i class="fas fa-edit ml-2"></i>الوصف التفصيلي
                    </h4>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">شرح الاقتراح *</label>
                        <textarea id="suggestionDescription" rows="4" placeholder="اشرح اقتراحك بالتفصيل..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required></textarea>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">الفوائد المتوقعة</label>
                        <textarea id="suggestionBenefits" rows="3" placeholder="ما هي الفوائد المتوقعة من هذا الاقتراح؟" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>

                <!-- تفاصيل التنفيذ -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                        <i class="fas fa-cogs ml-2"></i>تفاصيل التنفيذ
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الميزانية المقترحة</label>
                            <input type="text" id="suggestionBudget" placeholder="مثال: 50,000 ريال" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">المدة الزمنية المقترحة</label>
                            <input type="text" id="suggestionTimeline" placeholder="مثال: 3 أشهر" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">الموارد المطلوبة</label>
                        <textarea id="suggestionResources" rows="2" placeholder="ما هي الموارد والأدوات المطلوبة؟" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>

                <!-- أزرار التحكم -->
                <div class="flex justify-end space-x-4 rtl:space-x-reverse pt-4 border-t border-gray-200">
                    <button type="button" onclick="hideSuggestionModal()" class="px-8 py-3 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition font-medium">
                        <i class="fas fa-times ml-2"></i>إلغاء
                    </button>
                    <button type="button" onclick="resetSuggestionForm()" class="px-8 py-3 text-amber-600 bg-amber-100 border border-amber-300 rounded-lg hover:bg-amber-200 transition font-medium">
                        <i class="fas fa-refresh ml-2"></i>إعادة تعيين
                    </button>
                    <button type="submit" class="px-8 py-3 bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-lg hover:from-yellow-600 hover:to-orange-600 transition font-medium shadow-lg">
                        <i class="fas fa-lightbulb ml-2"></i>إرسال الاقتراح
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Library Modal -->
    <div id="libraryModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl w-full max-w-2xl max-h-screen overflow-y-auto mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-book text-blue-500 ml-2"></i>
                    إضافة محتوى للمكتبة الرقمية
                </h2>
                <button onclick="hideLibraryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="libraryForm" onsubmit="handleLibrarySubmit(event)">
                <!-- معلومات المحتوى الأساسية -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                        <i class="fas fa-info-circle ml-2"></i>معلومات المحتوى
                    </h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">عنوان المحتوى *</label>
                            <input type="text" id="libraryTitle" placeholder="مثال: تاريخ العائلة" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">نوع المحتوى *</label>
                                <select id="libraryType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">-- اختر النوع --</option>
                                    <option value="document">📄 وثيقة</option>
                                    <option value="book">📚 كتاب</option>
                                    <option value="article">📝 مقال</option>
                                    <option value="video">🎥 فيديو</option>
                                    <option value="audio">🎵 صوتي</option>
                                    <option value="image">🖼️ صورة</option>
                                    <option value="presentation">📊 عرض تقديمي</option>
                                    <option value="research">🔬 بحث</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">الفئة *</label>
                                <select id="libraryCategory" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">-- اختر الفئة --</option>
                                    <option value="family_history">🏛️ تاريخ العائلة</option>
                                    <option value="genealogy">🌳 الأنساب</option>
                                    <option value="documents">📋 الوثائق الرسمية</option>
                                    <option value="photos">📸 الصور والذكريات</option>
                                    <option value="achievements">🏆 الإنجازات</option>
                                    <option value="stories">📖 القصص والحكايات</option>
                                    <option value="education">🎓 التعليم والمهارات</option>
                                    <option value="business">💼 الأعمال والتجارة</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">المؤلف/المنشئ</label>
                            <input type="text" id="libraryAuthor" placeholder="اسم المؤلف أو المنشئ" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <!-- الوصف والمحتوى -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-green-800 mb-4 flex items-center">
                        <i class="fas fa-edit ml-2"></i>الوصف والمحتوى
                    </h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">وصف المحتوى *</label>
                            <textarea id="libraryDescription" rows="4" placeholder="وصف تفصيلي للمحتوى..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الكلمات المفتاحية</label>
                            <input type="text" id="libraryKeywords" placeholder="فصل الكلمات بفواصل، مثال: تاريخ، عائلة، وثائق" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1">استخدم الفواصل لفصل الكلمات المفتاحية</p>
                        </div>
                    </div>
                </div>

                <!-- تفاصيل إضافية -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                        <i class="fas fa-cogs ml-2"></i>تفاصيل إضافية
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ الإنشاء</label>
                            <input type="date" id="libraryDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">اللغة</label>
                            <select id="libraryLanguage" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="arabic">العربية</option>
                                <option value="english">الإنجليزية</option>
                                <option value="other">أخرى</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">رابط المحتوى (اختياري)</label>
                        <input type="url" id="libraryUrl" placeholder="https://example.com/file.pdf" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">رابط مباشر للملف أو المحتوى على الإنترنت</p>
                    </div>
                </div>

                <!-- خصائص الوصول -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-amber-800 mb-4 flex items-center">
                        <i class="fas fa-lock ml-2"></i>خصائص الوصول
                    </h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">مستوى الوصول</label>
                            <select id="libraryAccess" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="public">🌍 عام - متاح للجميع</option>
                                <option value="family" selected>👨‍👩‍👧‍👦 عائلي - أعضاء العائلة فقط</option>
                                <option value="admin">🔒 إداري - المديرين فقط</option>
                            </select>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="libraryFeatured" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="libraryFeatured" class="mr-2 block text-sm text-gray-900">
                                محتوى مميز (يظهر في المقدمة)
                            </label>
                        </div>
                    </div>
                </div>

                <!-- أزرار التحكم -->
                <div class="flex justify-end space-x-4 rtl:space-x-reverse pt-4 border-t border-gray-200">
                    <button type="button" onclick="hideLibraryModal()" class="px-8 py-3 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition font-medium">
                        <i class="fas fa-times ml-2"></i>إلغاء
                    </button>
                    <button type="button" onclick="resetLibraryForm()" class="px-8 py-3 text-amber-600 bg-amber-100 border border-amber-300 rounded-lg hover:bg-amber-200 transition font-medium">
                        <i class="fas fa-refresh ml-2"></i>إعادة تعيين
                    </button>
                    <button type="submit" class="px-8 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 transition font-medium shadow-lg">
                        <i class="fas fa-book ml-2"></i>إضافة للمكتبة
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // بيانات العائلة الأساسية
        const SAMPLE_FAMILY_DATA = {
            familyMembers: [
                // الجيل المؤسس
                {
                    id: 'founder_001',
                    full_name: 'محمد بن سعيدان',
                    first_name: 'محمد',
                    middle_name: '',
                    last_name: 'بن سعيدان',
                    membership_type: 'founder',
                    gender: 'male',
                    father_id: null,
                    generation: 1,
                    birth_date: '1950-01-01',
                    birth_place: 'الرياض، المملكة العربية السعودية',
                    profession: 'رجل أعمال',
                    specialization: 'التطوير العقاري',
                    phone: '0533361154',
                    email: 'info@salmansaedan.com',
                    hobbies: 'القراءة، الاستثمار العقاري، الأعمال الخيرية',
                    created_at: '2024-01-01'
                },
                // الجيل الثاني - الابن الحقيقي
                {
                    id: 'gen2_son1',
                    full_name: 'سلمان محمد بن سعيدان',
                    first_name: 'سلمان',
                    middle_name: 'محمد',
                    last_name: 'بن سعيدان',
                    membership_type: 'chairman',
                    gender: 'male',
                    father_id: 'founder_001',
                    generation: 2,
                    birth_date: '1975-05-15',
                    birth_place: 'الرياض، المملكة العربية السعودية',
                    profession: 'مطور عقاري',
                    specialization: 'إدارة المشاريع العقارية',
                    phone: '0533361156',
                    email: 'salman@salmansaedan.com',
                    hobbies: 'السفر، التصوير، الرياضة، تطوير الأعمال',
                    created_at: '2024-01-02'
                }
            ],
            events: [
                {
                    id: 'event_001',
                    title: 'اجتماع العائلة السنوي',
                    description: 'الاجتماع السنوي لجميع أفراد العائلة',
                    date: '2024-12-15',
                    time: '18:00',
                    location: 'قاعة الملك فهد',
                    type: 'family',
                    status: 'upcoming',
                    attendees: 45
                }
            ],
            suggestions: [
                {
                    id: 'sugg_001',
                    title: 'تطوير تطبيق الجوال للعائلة',
                    category: 'technology',
                    priority: 'high',
                    description: 'إنشاء تطبيق جوال متقدم لإدارة شؤون العائلة والتواصل بين الأعضاء',
                    benefits: 'تسهيل التواصل، إدارة الأحداث، مشاركة الصور والذكريات',
                    budget: '75,000 ريال',
                    timeline: '6 أشهر',
                    resources: 'فريق تطوير، مصمم واجهات، مطور تطبيقات',
                    status: 'pending',
                    submitted_by: 'سلمان محمد بن سعيدان',
                    submitted_date: '2024-01-15',
                    votes: {
                        up: 18,
                        down: 2
                    },
                    comments: []
                },
                {
                    id: 'sugg_002',
                    title: 'تنظيم لقاء عائلي سنوي',
                    category: 'events',
                    priority: 'medium',
                    description: 'تنظيم لقاء عائلي سنوي يجمع جميع أفراد العائلة للتواصل وتقوية الروابط',
                    benefits: 'تقوية الروابط العائلية، تبادل الخبرات، إحياء التقاليد',
                    budget: '25,000 ريال',
                    timeline: '3 أشهر للتحضير',
                    resources: 'قاعة مناسبة، تنسيق الطعام، برنامج ترفيهي',
                    status: 'approved',
                    submitted_by: 'محمد بن سعيدان',
                    submitted_date: '2024-02-01',
                    votes: {
                        up: 24,
                        down: 1
                    },
                    comments: []
                },
                {
                    id: 'sugg_003',
                    title: 'إنشاء صندوق تعاوني للعائلة',
                    category: 'business',
                    priority: 'high',
                    description: 'تأسيس صندوق تعاوني لدعم أفراد العائلة في المشاريع والطوارئ',
                    benefits: 'الدعم المالي، تطوير المشاريع، التضامن العائلي',
                    budget: '500,000 ريال رأس مال أولي',
                    timeline: '4 أشهر للإجراءات القانونية',
                    resources: 'محامي متخصص، محاسب قانوني، مدير الصندوق',
                    status: 'under_review',
                    submitted_by: 'سلمان محمد بن سعيدان',
                    submitted_date: '2024-01-20',
                    votes: {
                        up: 12,
                        down: 5
                    },
                    comments: []
                }
            ],
            library: [
                {
                    id: 'lib_001',
                    title: 'تاريخ وأصول عائلة آل سعيدان',
                    author: 'محمد بن سعيدان',
                    type: 'document',
                    category: 'family_history',
                    description: 'وثيقة شاملة عن تاريخ العائلة وأصولها التي تمتد لقرون من الزمن',
                    keywords: ['تاريخ', 'نسب', 'عائلة', 'أصول', 'تراث'],
                    created_date: '2023-12-01',
                    language: 'arabic',
                    access_level: 'family',
                    featured: true,
                    url: '#',
                    views: 45,
                    downloads: 12
                },
                {
                    id: 'lib_002',
                    title: 'شجرة النسب الكاملة للعائلة',
                    author: 'نسابة متخصص',
                    type: 'document',
                    category: 'genealogy',
                    description: 'مخطط تفصيلي لشجرة النسب يوضح العلاقات العائلية عبر الأجيال',
                    keywords: ['نسب', 'شجرة', 'أجيال', 'علاقات عائلية'],
                    created_date: '2024-01-10',
                    language: 'arabic',
                    access_level: 'family',
                    featured: true,
                    url: '#',
                    views: 67,
                    downloads: 23
                },
                {
                    id: 'lib_003',
                    title: 'الوثائق الرسمية والسجلات',
                    author: 'إدارة الأرشيف العائلي',
                    type: 'document',
                    category: 'documents',
                    description: 'مجموعة الوثائق الرسمية والسجلات المهمة للعائلة',
                    keywords: ['وثائق', 'سجلات', 'رسمي', 'أرشيف'],
                    created_date: '2024-01-05',
                    language: 'arabic',
                    access_level: 'admin',
                    featured: false,
                    url: '#',
                    views: 28,
                    downloads: 8
                },
                {
                    id: 'lib_004',
                    title: 'صور وذكريات العائلة عبر التاريخ',
                    author: 'أرشيف العائلة',
                    type: 'image',
                    category: 'photos',
                    description: 'مجموعة نادرة من الصور التاريخية والذكريات العائلية الثمينة',
                    keywords: ['صور', 'ذكريات', 'تاريخ', 'عائلة', 'تراث'],
                    created_date: '2024-02-01',
                    language: 'arabic',
                    access_level: 'public',
                    featured: true,
                    url: '#',
                    views: 89,
                    downloads: 34
                },
                {
                    id: 'lib_005',
                    title: 'إنجازات العائلة في مجال الأعمال',
                    author: 'سلمان محمد بن سعيدان',
                    type: 'presentation',
                    category: 'achievements',
                    description: 'عرض تقديمي يبرز الإنجازات التجارية والاستثمارية للعائلة',
                    keywords: ['إنجازات', 'أعمال', 'استثمار', 'نجاح', 'تجارة'],
                    created_date: '2024-01-25',
                    language: 'arabic',
                    access_level: 'family',
                    featured: true,
                    url: '#',
                    views: 52,
                    downloads: 19
                },
                {
                    id: 'lib_006',
                    title: 'حكايات وقصص من التراث العائلي',
                    author: 'رواة العائلة',
                    type: 'audio',
                    category: 'stories',
                    description: 'مجموعة من القصص والحكايات المتوارثة التي تحكي تاريخ العائلة',
                    keywords: ['حكايات', 'قصص', 'تراث', 'موروث', 'شفهي'],
                    created_date: '2024-02-10',
                    language: 'arabic',
                    access_level: 'family',
                    featured: false,
                    url: '#',
                    views: 31,
                    downloads: 7
                }
            ]
        };

        // نظام إدارة المستخدمين والمصادقة
        class UserManager {
            constructor() {
                this.usersStorageKey = 'al_saedan_users_v1';
                this.currentUserKey = 'al_saedan_current_user';
                this.users = this.loadUsers();
                this.currentUser = this.loadCurrentUser();
                this.initializeDefaultAdmin();
            }

            loadUsers() {
                try {
                    const stored = localStorage.getItem(this.usersStorageKey);
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('خطأ في تحميل المستخدمين:', error);
                    return [];
                }
            }

            saveUsers() {
                try {
                    localStorage.setItem(this.usersStorageKey, JSON.stringify(this.users));
                    return true;
                } catch (error) {
                    console.error('خطأ في حفظ المستخدمين:', error);
                    return false;
                }
            }

            loadCurrentUser() {
                try {
                    const stored = localStorage.getItem(this.currentUserKey);
                    return stored ? JSON.parse(stored) : null;
                } catch (error) {
                    return null;
                }
            }

            saveCurrentUser(user) {
                try {
                    if (user) {
                        localStorage.setItem(this.currentUserKey, JSON.stringify(user));
                    } else {
                        localStorage.removeItem(this.currentUserKey);
                    }
                    this.currentUser = user;
                    return true;
                } catch (error) {
                    console.error('خطأ في حفظ المستخدم الحالي:', error);
                    return false;
                }
            }

            initializeDefaultAdmin() {
                // التأكد من وجود حساب المدير الافتراضي الصحيح
                const defaultAdminEmail = 'admin@salmansaedan.com';
                let adminUser = this.users.find(u => u.email === defaultAdminEmail);
                
                if (!adminUser) {
                    // إنشاء المدير الافتراضي إذا لم يكن موجوداً
                    const defaultAdmin = {
                        id: 'admin_default',
                        national_id: '1000000000',
                        first_name: 'مدير',
                        middle_name: 'النظام',
                        last_name: 'الافتراضي',
                        full_name: 'مدير النظام الافتراضي',
                        email: defaultAdminEmail,
                        phone: '0533361154',
                        password: this.hashPassword('admin123'),
                        role: 'admin',
                        status: 'active',
                        birth_date: '1970-01-01',
                        birth_place: 'الرياض',
                        profession: 'إدارة النظام',
                        specialization: 'إدارة تقنية المعلومات',
                        hobbies: 'إدارة الأنظمة، التطوير التقني',
                        father_id: null,
                        generation: 1,
                        created_at: new Date().toISOString(),
                        approved_at: new Date().toISOString(),
                        approved_by: 'system'
                    };
                    this.users.push(defaultAdmin);
                    this.saveUsers();
                    console.log('✅ تم إنشاء حساب المدير الافتراضي');
                } else {
                    // التأكد من أن كلمة المرور صحيحة للمدير الموجود
                    if (adminUser.role !== 'admin' || adminUser.status !== 'active') {
                        adminUser.role = 'admin';
                        adminUser.status = 'active';
                        adminUser.password = this.hashPassword('admin123');
                        this.saveUsers();
                        console.log('✅ تم تحديث صلاحيات المدير الافتراضي');
                    }
                }
                
                // طباعة معلومات المدير للتأكيد
                const admin = this.users.find(u => u.email === defaultAdminEmail);
                if (admin) {
                    console.log('🔐 معلومات المدير الافتراضي:');
                    console.log('   البريد الإلكتروني:', admin.email);
                    console.log('   كلمة المرور: admin123');
                    console.log('   الحالة:', admin.status);
                    console.log('   الدور:', admin.role);
                }
            }

            hashPassword(password) {
                // تشفير بسيط - في التطبيق الحقيقي استخدم تشفير أقوى
                return btoa(password + 'salt_key_2024');
            }

            verifyPassword(inputPassword, hashedPassword) {
                return this.hashPassword(inputPassword) === hashedPassword;
            }

            generateId() {
                return 'user_' + Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            // تسجيل مستخدم جديد
            registerUser(userData) {
                // التحقق من عدم وجود المستخدم
                const existingUser = this.users.find(u => 
                    u.national_id === userData.national_id || u.email === userData.email
                );
                
                if (existingUser) {
                    throw new Error('المستخدم موجود بالفعل بنفس رقم الهوية أو البريد الإلكتروني');
                }

                const newUser = {
                    id: this.generateId(),
                    ...userData,
                    password: this.hashPassword(userData.password),
                    role: 'user',
                    status: 'pending', // في انتظار الموافقة
                    created_at: new Date().toISOString(),
                    approved_at: null,
                    approved_by: null
                };

                this.users.push(newUser);
                this.saveUsers();
                return newUser;
            }

            // تسجيل دخول
            login(identifier, password) {
                console.log('🔍 محاولة تسجيل دخول:');
                console.log('   المعرف:', identifier);
                console.log('   عدد المستخدمين المحفوظين:', this.users.length);
                
                // البحث عن المستخدم
                const user = this.users.find(u => 
                    u.national_id === identifier || u.email === identifier
                );

                if (!user) {
                    console.log('❌ لم يتم العثور على المستخدم');
                    console.log('المستخدمون المتاحون:');
                    this.users.forEach(u => console.log(`   - ${u.email} (${u.national_id})`));
                    throw new Error('المستخدم غير موجود');
                }

                console.log('✅ تم العثور على المستخدم:', user.email);
                console.log('   حالة المستخدم:', user.status);
                console.log('   دور المستخدم:', user.role);

                if (user.status !== 'active') {
                    throw new Error('الحساب غير مفعل. يرجى انتظار موافقة الإدارة.');
                }

                // التحقق من كلمة المرور
                const passwordHash = this.hashPassword(password);
                console.log('🔐 التحقق من كلمة المرور...');
                console.log('   كلمة المرور المدخلة (مشفرة):', passwordHash);
                console.log('   كلمة المرور المحفوظة:', user.password);

                if (!this.verifyPassword(password, user.password)) {
                    console.log('❌ كلمة المرور غير صحيحة');
                    throw new Error('كلمة المرور غير صحيحة');
                }

                console.log('✅ تم تسجيل الدخول بنجاح');
                this.saveCurrentUser(user);
                return user;
            }

            // تسجيل خروج
            logout() {
                this.saveCurrentUser(null);
                return true;
            }

            // الحصول على المستخدمين المعلقين
            getPendingUsers() {
                return this.users.filter(u => u.status === 'pending');
            }

            // الحصول على المستخدمين المفعلين
            getActiveUsers() {
                return this.users.filter(u => u.status === 'active');
            }

            // تفعيل مستخدم (للإدمن فقط)
            approveUser(userId, adminId) {
                const userIndex = this.users.findIndex(u => u.id === userId);
                const admin = this.users.find(u => u.id === adminId && u.role === 'admin');

                if (userIndex === -1) {
                    throw new Error('المستخدم غير موجود');
                }

                if (!admin) {
                    throw new Error('ليس لديك صلاحية لتفعيل المستخدمين');
                }

                this.users[userIndex].status = 'active';
                this.users[userIndex].approved_at = new Date().toISOString();
                this.users[userIndex].approved_by = adminId;

                this.saveUsers();
                return this.users[userIndex];
            }

            // رفض مستخدم (للإدمن فقط)
            rejectUser(userId, adminId) {
                const userIndex = this.users.findIndex(u => u.id === userId);
                const admin = this.users.find(u => u.id === adminId && u.role === 'admin');

                if (userIndex === -1) {
                    throw new Error('المستخدم غير موجود');
                }

                if (!admin) {
                    throw new Error('ليس لديك صلاحية لرفض المستخدمين');
                }

                this.users.splice(userIndex, 1);
                this.saveUsers();
                return true;
            }

            // التحقق من الصلاحيات
            hasPermission(action) {
                if (!this.currentUser || this.currentUser.status !== 'active') {
                    return false;
                }

                const permissions = {
                    admin: ['view_all', 'edit_all', 'delete_all', 'approve_users', 'manage_system'],
                    user: ['view_own', 'edit_own', 'comment_only']
                };

                return permissions[this.currentUser.role]?.includes(action) || false;
            }

            // تحديث بيانات المستخدم
            updateUser(userId, updateData) {
                const userIndex = this.users.findIndex(u => u.id === userId);
                
                if (userIndex === -1) {
                    throw new Error('المستخدم غير موجود');
                }

                // التحقق من الصلاحيات
                if (this.currentUser.id !== userId && this.currentUser.role !== 'admin') {
                    throw new Error('ليس لديك صلاحية لتعديل هذا المستخدم');
                }

                // منع تغيير بيانات حساسة للمستخدمين العاديين
                const restrictedFields = ['role', 'status', 'approved_at', 'approved_by'];
                if (this.currentUser.role !== 'admin') {
                    restrictedFields.forEach(field => delete updateData[field]);
                }

                this.users[userIndex] = {
                    ...this.users[userIndex],
                    ...updateData,
                    updated_at: new Date().toISOString()
                };

                this.saveUsers();
                
                // تحديث المستخدم الحالي إذا كان هو نفسه
                if (this.currentUser.id === userId) {
                    this.saveCurrentUser(this.users[userIndex]);
                }

                return this.users[userIndex];
            }

            // دالة لإعادة تعيين المدير الافتراضي (للاستخدام في وحدة التحكم)
            resetDefaultAdmin() {
                // حذف المدير الحالي
                this.users = this.users.filter(u => u.email !== 'admin@salmansaedan.com');
                
                // إضافة المدير الجديد
                const defaultAdmin = {
                    id: 'admin_default_' + Date.now(),
                    national_id: '1000000000',
                    first_name: 'مدير',
                    middle_name: 'النظام',
                    last_name: 'الافتراضي',
                    full_name: 'مدير النظام الافتراضي',
                    email: 'admin@salmansaedan.com',
                    phone: '0533361154',
                    password: this.hashPassword('admin123'),
                    role: 'admin',
                    status: 'active',
                    birth_date: '1970-01-01',
                    birth_place: 'الرياض',
                    profession: 'إدارة النظام',
                    specialization: 'إدارة تقنية المعلومات',
                    hobbies: 'إدارة الأنظمة، التطوير التقني',
                    father_id: null,
                    generation: 1,
                    created_at: new Date().toISOString(),
                    approved_at: new Date().toISOString(),
                    approved_by: 'system'
                };
                
                this.users.push(defaultAdmin);
                this.saveUsers();
                
                console.log('✅ تم إعادة تعيين المدير الافتراضي:');
                console.log('   البريد الإلكتروني: admin@salmansaedan.com');
                console.log('   كلمة المرور: admin123');
                
                return defaultAdmin;
            }
        }

        // نظام إدارة البيانات المحسن
        class EnhancedDataManager {
            constructor() {
                this.storageKey = 'al_saedan_app_v2';
                this.data = this.loadData();
                this.initializeDefaultData();
                this.setupStorageSync();
            }

            loadData() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        return {
                            familyMembers: parsed.familyMembers || [],
                            events: parsed.events || [],
                            suggestions: parsed.suggestions || [],
                            library: parsed.library || [],
                            lastUpdated: parsed.lastUpdated || new Date().toISOString(),
                            version: parsed.version || 1
                        };
                    }
                    return {
                        familyMembers: [],
                        events: [],
                        suggestions: [],
                        library: [],
                        lastUpdated: new Date().toISOString(),
                        version: 1
                    };
                } catch (error) {
                    console.error('خطأ في تحميل البيانات:', error);
                    return {
                        familyMembers: [],
                        events: [],
                        suggestions: [],
                        library: [],
                        lastUpdated: new Date().toISOString(),
                        version: 1
                    };
                }
            }

            saveData() {
                try {
                    this.data.lastUpdated = new Date().toISOString();
                    this.data.version = (this.data.version || 0) + 1;
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    
                    // إشعال حدث تحديث البيانات
                    window.dispatchEvent(new CustomEvent('dataUpdated', { detail: this.data }));
                    
                    return true;
                } catch (error) {
                    console.error('خطأ في حفظ البيانات:', error);
                    return false;
                }
            }

            initializeDefaultData() {
                // تحميل البيانات الأساسية إذا كانت فارغة
                if (this.data.familyMembers.length === 0) {
                    console.log('📊 لا توجد بيانات عائلية - جاهز لتحميل البيانات الأساسية');
                } else {
                    console.log(`✅ تم العثور على ${this.data.familyMembers.length} عضو في العائلة`);
                    // التحقق من استرجاع بيانات الجيل الثاني
                    const secondGenMembers = this.data.familyMembers.filter(m => m.generation === 2);
                    console.log(`🌳 الجيل الثاني: ${secondGenMembers.length} أعضاء`);
                    secondGenMembers.forEach(member => {
                        console.log(`   - ${member.full_name} (الوالد: ${member.father_id || 'غير محدد'})`);
                    });
                    
                    // تحديث مراجع الأطفال للأعضاء الموجودين
                    this.updateChildrenReferences();
                }
            }

            // تحديث مراجع الأطفال لكل عضو
            updateChildrenReferences() {
                this.data.familyMembers.forEach(member => {
                    member.children = this.data.familyMembers
                        .filter(child => child.father_id === member.id)
                        .map(child => child.id);
                });
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            getData(category) {
                return this.data[category] || [];
            }

            addItem(category, item) {
                if (!this.data[category]) {
                    this.data[category] = [];
                }
                
                // حساب الجيل للأعضاء الجدد
                if (category === 'familyMembers') {
                    item.generation = this.calculateGeneration(item.father_id);
                    item.id = item.id || this.generateId();
                    item.created_at = item.created_at || new Date().toISOString();
                }
                
                const newItem = {
                    ...item,
                    id: item.id || this.generateId(),
                    created_at: item.created_at || new Date().toISOString()
                };
                
                this.data[category].push(newItem);
                
                // تحديث مراجع الأطفال للعائلة
                if (category === 'familyMembers') {
                    this.updateChildrenReferences();
                }
                
                this.saveData();
                return newItem;
            }

            // حساب الجيل بناءً على الوالد
            calculateGeneration(fatherId) {
                if (!fatherId) return 1; // المؤسس
                
                const father = this.data.familyMembers.find(m => m.id === fatherId);
                return father ? (father.generation + 1) : 1;
            }

            updateItem(category, id, updates) {
                const items = this.data[category];
                const index = items.findIndex(item => item.id === id);
                
                if (index !== -1) {
                    // إذا تم تحديث الوالد، إعادة حساب الجيل
                    if (category === 'familyMembers' && updates.father_id !== undefined) {
                        updates.generation = this.calculateGeneration(updates.father_id);
                    }
                    
                    items[index] = { 
                        ...items[index], 
                        ...updates,
                        updated_at: new Date().toISOString()
                    };
                    
                    // تحديث مراجع الأطفال للعائلة
                    if (category === 'familyMembers') {
                        this.updateChildrenReferences();
                    }
                    
                    this.saveData();
                    return items[index];
                }
                return null;
            }

            deleteItem(category, id) {
                const items = this.data[category];
                const index = items.findIndex(item => item.id === id);
                
                if (index !== -1) {
                    // للعائلة: التحقق من وجود أطفال
                    if (category === 'familyMembers') {
                        const hasChildren = this.data.familyMembers.some(m => m.father_id === id);
                        if (hasChildren) {
                            throw new Error('لا يمكن حذف عضو لديه أطفال. احذف الأطفال أولاً.');
                        }
                    }
                    
                    const deletedItem = items.splice(index, 1)[0];
                    
                    // تحديث مراجع الأطفال للعائلة
                    if (category === 'familyMembers') {
                        this.updateChildrenReferences();
                    }
                    
                    this.saveData();
                    return deletedItem;
                }
                return null;
            }

            // تحميل البيانات النموذجية
            loadSampleData() {
                this.data = { ...this.data, ...SAMPLE_FAMILY_DATA };
                this.updateChildrenReferences();
                this.saveData();
                
                // تأكيد استرجاع بيانات الجيل الثاني
                const secondGenMembers = this.data.familyMembers.filter(m => m.generation === 2);
                console.log('📊 تحميل البيانات النموذجية مكتمل:');
                console.log(`   - إجمالي الأعضاء: ${this.data.familyMembers.length}`);
                console.log(`   - الجيل الثاني: ${secondGenMembers.length} أعضاء`);
                console.log('✅ تم تحميل البيانات النموذجية بنجاح مع ربط الأجيال');
                
                // إشعال حدث تحديث البيانات
                window.dispatchEvent(new CustomEvent('sampleDataLoaded', { 
                    detail: { 
                        totalMembers: this.data.familyMembers.length,
                        secondGeneration: secondGenMembers.length
                    } 
                }));
            }

            // مزامنة مع النوافذ الأخرى
            setupStorageSync() {
                window.addEventListener('storage', (e) => {
                    if (e.key === this.storageKey) {
                        this.data = this.loadData();
                        window.dispatchEvent(new CustomEvent('dataUpdated', { detail: this.data }));
                    }
                });
            }

            // البحث والفلترة
            searchItems(category, query, filters = {}) {
                let items = this.getData(category);

                // البحث النصي
                if (query) {
                    const searchTerms = query.toLowerCase().split(' ');
                    items = items.filter(item => 
                        searchTerms.every(term =>
                            Object.values(item).some(value =>
                                value && value.toString().toLowerCase().includes(term)
                            )
                        )
                    );
                }

                // تطبيق الفلاتر
                Object.keys(filters).forEach(key => {
                    if (filters[key]) {
                        items = items.filter(item => item[key] === filters[key]);
                    }
                });

                return items;
            }
        }

        // التطبيق الرئيسي المحسن
        class EnhancedAlSaedanApp {
            constructor() {
                this.dataManager = new EnhancedDataManager();
                this.userManager = new UserManager();
                this.charts = {};
                this.init();
            }

            init() {
                this.updateAuthUI();
                this.createModals();
                this.displayHomeStatistics();
                this.displayFamilyTree();
                this.displayEvents();
                this.displaySuggestions();
                this.displayLibrary();
                this.displayProfile();
                this.displayAdminPanel();
                this.initializeCharts();
                this.setupEventListeners();
                console.log('تم تحميل التطبيق الشامل المحسن بنجاح');
            }

            // تحديث واجهة المصادقة
            updateAuthUI() {
                const isLoggedIn = this.userManager.currentUser !== null;
                const isAdmin = this.userManager.currentUser?.role === 'admin';

                // إظهار/إخفاء العناصر حسب حالة تسجيل الدخول
                const mainNavigation = document.getElementById('mainNavigation');
                const userProfileMenu = document.getElementById('userProfileMenu');
                const authButtons = document.getElementById('authButtons');
                const adminButton = document.getElementById('nav-admin');
                const currentUserName = document.getElementById('currentUserName');

                if (isLoggedIn) {
                    mainNavigation.classList.remove('hidden');
                    userProfileMenu.classList.remove('hidden');
                    authButtons.classList.add('hidden');
                    
                    if (currentUserName) {
                        currentUserName.textContent = this.userManager.currentUser.first_name;
                    }
                    
                    if (isAdmin && adminButton) {
                        adminButton.classList.remove('hidden');
                    }
                } else {
                    mainNavigation.classList.add('hidden');
                    userProfileMenu.classList.add('hidden');
                    authButtons.classList.remove('hidden');
                    if (adminButton) {
                        adminButton.classList.add('hidden');
                    }
                }
            }

            // عرض الملف الشخصي
            displayProfile() {
                const container = document.getElementById('profileContent');
                if (!container) return;

                const user = this.userManager.currentUser;
                if (!user) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl text-white mb-4 opacity-50">
                                <i class="fas fa-user-slash"></i>
                            </div>
                            <p class="text-white text-xl mb-4">يرجى تسجيل الدخول أولاً</p>
                        </div>
                    `;
                    return;
                }

                const statusBadge = user.status === 'active' ? 
                    '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">مفعل</span>' :
                    '<span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-medium">في انتظار التفعيل</span>';

                const roleBadge = user.role === 'admin' ?
                    '<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">👑 مدير</span>' :
                    '<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">👤 عضو</span>';

                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-4 rtl:space-x-reverse">
                                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                                    ${user.first_name.charAt(0)}${user.last_name.charAt(0)}
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-800">${user.full_name}</h3>
                                    <div class="flex items-center space-x-2 rtl:space-x-reverse mt-2">
                                        ${statusBadge}
                                        ${roleBadge}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- المعلومات الشخصية -->
                            <div class="space-y-4">
                                <h4 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2">
                                    <i class="fas fa-user ml-2 text-blue-600"></i>المعلومات الشخصية
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="font-medium text-gray-600">رقم الهوية:</span>
                                        <span class="text-gray-800">${user.national_id}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium text-gray-600">تاريخ الميلاد:</span>
                                        <span class="text-gray-800">${user.birth_date ? new Date(user.birth_date).toLocaleDateString('ar-SA') : 'غير محدد'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium text-gray-600">مكان الميلاد:</span>
                                        <span class="text-gray-800">${user.birth_place || 'غير محدد'}</span>
                                    </div>
                                    ${user.generation ? `
                                        <div class="flex justify-between">
                                            <span class="font-medium text-gray-600">الجيل:</span>
                                            <span class="text-gray-800">الجيل ${user.generation}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- المعلومات المهنية -->
                            <div class="space-y-4">
                                <h4 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2">
                                    <i class="fas fa-briefcase ml-2 text-green-600"></i>المعلومات المهنية
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="font-medium text-gray-600">المهنة:</span>
                                        <span class="text-gray-800">${user.profession || 'غير محدد'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium text-gray-600">التخصص:</span>
                                        <span class="text-gray-800">${user.specialization || 'غير محدد'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- معلومات التواصل -->
                            <div class="space-y-4">
                                <h4 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2">
                                    <i class="fas fa-phone ml-2 text-teal-600"></i>معلومات التواصل
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="font-medium text-gray-600">الجوال:</span>
                                        <span class="text-gray-800">${user.phone || 'غير محدد'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium text-gray-600">الإيميل:</span>
                                        <span class="text-gray-800">${user.email || 'غير محدد'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- الهوايات -->
                            <div class="space-y-4">
                                <h4 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2">
                                    <i class="fas fa-heart ml-2 text-rose-600"></i>الهوايات والاهتمامات
                                </h4>
                                <p class="text-sm text-gray-700">${user.hobbies || 'لم يتم تحديد هوايات'}</p>
                            </div>
                        </div>

                        <!-- تواريخ مهمة -->
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs text-gray-500">
                                <div>تاريخ التسجيل: ${new Date(user.created_at).toLocaleDateString('ar-SA')}</div>
                                ${user.approved_at ? `<div>تاريخ التفعيل: ${new Date(user.approved_at).toLocaleDateString('ar-SA')}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            // عرض لوحة الإدارة
            displayAdminPanel() {
                if (!this.userManager.currentUser || this.userManager.currentUser.role !== 'admin') {
                    return;
                }

                const pendingContainer = document.getElementById('pendingUsersGrid');
                const activeUsersCount = document.getElementById('activeUsersCount');
                const pendingUsersCount = document.getElementById('pendingUsersCount');
                const totalUsersCount = document.getElementById('totalUsersCount');

                if (!pendingContainer) return;

                const pendingUsers = this.userManager.getPendingUsers();
                const activeUsers = this.userManager.getActiveUsers();
                const totalUsers = this.userManager.users.length;

                // تحديث الإحصائيات
                if (activeUsersCount) activeUsersCount.textContent = activeUsers.length;
                if (pendingUsersCount) pendingUsersCount.textContent = pendingUsers.length;
                if (totalUsersCount) totalUsersCount.textContent = totalUsers;

                // عرض المستخدمين المعلقين
                if (pendingUsers.length === 0) {
                    pendingContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-check-circle text-4xl mb-2"></i>
                            <p>لا توجد طلبات تسجيل معلقة</p>
                        </div>
                    `;
                    return;
                }

                pendingContainer.innerHTML = pendingUsers.map(user => `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">${user.full_name}</h4>
                                <div class="mt-2 space-y-1 text-sm text-gray-600">
                                    <div>📧 ${user.email}</div>
                                    <div>📱 ${user.phone}</div>
                                    <div>🆔 ${user.national_id}</div>
                                    <div>💼 ${user.profession} - ${user.specialization}</div>
                                    <div>📅 ${new Date(user.created_at).toLocaleDateString('ar-SA')}</div>
                                </div>
                                ${user.hobbies ? `
                                    <div class="mt-2 p-2 bg-blue-50 rounded text-xs">
                                        <strong>الهوايات:</strong> ${user.hobbies}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex flex-col space-y-2 mr-4">
                                <button onclick="approveUser('${user.id}')" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                    <i class="fas fa-check ml-1"></i>موافقة
                                </button>
                                <button onclick="rejectUser('${user.id}')" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700">
                                    <i class="fas fa-times ml-1"></i>رفض
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            setupEventListeners() {
                // مستمع تحديث البيانات
                window.addEventListener('dataUpdated', () => {
                    this.refreshAllSections();
                });

                // مستمع تحميل البيانات النموذجية
                window.addEventListener('sampleDataLoaded', (event) => {
                    const { totalMembers, secondGeneration } = event.detail;
                    console.log(`🎉 البيانات النموذجية محملة: ${totalMembers} أعضاء، ${secondGeneration} في الجيل الثاني`);
                    
                    // التحقق من استرجاع بيانات الجيل الثاني
                    const members = this.dataManager.getData('familyMembers');
                    const secondGenData = members.filter(m => m.generation === 2);
                    console.log('📋 تفاصيل الجيل الثاني المسترجع:');
                    secondGenData.forEach(member => {
                        console.log(`   ✓ ${member.full_name} - جيل ${member.generation} - والد: ${member.father_id}`);
                    });
                });

                // مستمع نموذج العائلة
                const familyForm = document.getElementById('familyForm');
                if (familyForm) {
                    familyForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveFamilyMember();
                    });
                }

                // مستمع نموذج تسجيل الدخول
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleLogin();
                    });
                }

                // مستمع نموذج التسجيل
                const registerForm = document.getElementById('registerForm');
                if (registerForm) {
                    registerForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleRegister();
                    });
                }

                // مستمعات حقول النموذج المحسن
                this.setupFormFieldListeners();
                this.setupRegisterFormListeners();
            }

            setupFormFieldListeners() {
                // تحديث معاينة الاسم الكامل
                const nameFields = ['familyFirstName', 'familyMiddleName', 'familyLastName'];
                nameFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.addEventListener('input', this.updateFullNamePreview.bind(this));
                    }
                });

                // تحديث الجيل عند اختيار الوالد
                const fatherSelect = document.getElementById('familyFatherId');
                if (fatherSelect) {
                    fatherSelect.addEventListener('change', this.updateGenerationDisplay.bind(this));
                }
            }

            updateFullNamePreview() {
                const firstName = document.getElementById('familyFirstName')?.value.trim() || '';
                const middleName = document.getElementById('familyMiddleName')?.value.trim() || '';
                const lastName = document.getElementById('familyLastName')?.value.trim() || '';
                
                let fullName = firstName;
                if (middleName) fullName += ` ${middleName}`;
                if (lastName) fullName += ` ${lastName}`;
                
                const preview = document.getElementById('fullNamePreview');
                if (preview) {
                    preview.textContent = fullName || 'سيتم تكوين الاسم تلقائياً...';
                }
            }

            updateGenerationDisplay() {
                const fatherSelect = document.getElementById('familyFatherId');
                const generationDisplay = document.getElementById('familyCurrentGeneration');
                
                if (!fatherSelect || !generationDisplay) return;

                const fatherId = fatherSelect.value;
                let generation = 1; // افتراضي للمؤسس

                if (fatherId) {
                    const father = this.dataManager.getData('familyMembers').find(m => m.id === fatherId);
                    generation = father ? (father.generation + 1) : 1;
                }

                generationDisplay.value = `الجيل ${generation} ${generation === 1 ? '(مؤسس)' : generation === 2 ? '(أطفال المؤسس)' : '(أحفاد)'}`;
            }

            // إعداد مستمعات نموذج التسجيل
            setupRegisterFormListeners() {
                // تحديث معاينة الاسم الكامل
                const nameFields = ['registerFirstName', 'registerMiddleName', 'registerLastName'];
                nameFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.addEventListener('input', updateRegisterFullNamePreview);
                    }
                });

                // تحديث الجيل المتوقع عند اختيار الوالد
                const fatherSelect = document.getElementById('registerFatherId');
                if (fatherSelect) {
                    fatherSelect.addEventListener('change', this.updateRegisterGeneration.bind(this));
                }
            }

            updateRegisterGeneration() {
                const fatherSelect = document.getElementById('registerFatherId');
                const generationDisplay = document.getElementById('registerExpectedGeneration');
                
                if (!fatherSelect || !generationDisplay) return;

                const fatherId = fatherSelect.value;
                let generation = 1; // افتراضي للمؤسس

                if (fatherId) {
                    const father = this.dataManager.getData('familyMembers').find(m => m.id === fatherId);
                    generation = father ? (father.generation + 1) : 1;
                }

                generationDisplay.value = `الجيل ${generation} ${generation === 1 ? '(مؤسس)' : generation === 2 ? '(أطفال المؤسس)' : '(أحفاد)'}`;
            }

            populateRegisterParentSelect() {
                const select = document.getElementById('registerFatherId');
                if (!select) return;

                select.innerHTML = '<option value="">-- اختر الوالد (اختياري) --</option>';
                
                const maleMembers = this.dataManager.getData('familyMembers').filter(m => m.gender === 'male');
                
                // تجميع حسب الأجيال
                const generations = {};
                maleMembers.forEach(member => {
                    const gen = member.generation || 1;
                    if (!generations[gen]) generations[gen] = [];
                    generations[gen].push(member);
                });
                
                // إضافة الخيارات مجموعة حسب الأجيال
                Object.keys(generations).sort((a, b) => parseInt(a) - parseInt(b)).forEach(genNum => {
                    const genGroup = document.createElement('optgroup');
                    genGroup.label = `${genNum == '1' ? 'الجيل المؤسس' : 'الجيل ' + genNum}`;
                    
                    generations[genNum].forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = member.full_name;
                        genGroup.appendChild(option);
                    });
                    
                    select.appendChild(genGroup);
                });
            }

            // معالجة تسجيل الدخول
            handleLogin() {
                const identifier = document.getElementById('loginIdentifier').value.trim();
                const password = document.getElementById('loginPassword').value.trim();

                if (!identifier || !password) {
                    this.showToast('يرجى ملء جميع الحقول', 'error');
                    return;
                }

                try {
                    const user = this.userManager.login(identifier, password);
                    this.showToast(`مرحباً ${user.first_name}! تم تسجيل الدخول بنجاح`, 'success');
                    hideLoginModal();
                    this.updateAuthUI();
                    showSection('home');
                } catch (error) {
                    this.showToast('خطأ في تسجيل الدخول: ' + error.message, 'error');
                }
            }

            // معالجة التسجيل الجديد
            handleRegister() {
                // جمع البيانات
                const firstName = document.getElementById('registerFirstName').value.trim();
                const middleName = document.getElementById('registerMiddleName').value.trim();
                const lastName = document.getElementById('registerLastName').value.trim();
                const nationalId = document.getElementById('registerNationalId').value.trim();
                const birthDate = document.getElementById('registerBirthDate').value;
                const birthPlace = document.getElementById('registerBirthPlace').value.trim();
                const fatherId = document.getElementById('registerFatherId').value || null;
                const profession = document.getElementById('registerProfession').value.trim();
                const specialization = document.getElementById('registerSpecialization').value.trim();
                const phone = document.getElementById('registerPhone').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const hobbies = document.getElementById('registerHobbies').value.trim();
                const password = document.getElementById('registerPassword').value.trim();
                const passwordConfirm = document.getElementById('registerPasswordConfirm').value.trim();
                const agree = document.getElementById('registerAgree').checked;

                // التحقق من البيانات المطلوبة
                if (!firstName || !middleName || !lastName || !nationalId || !birthDate || !birthPlace || 
                    !profession || !specialization || !phone || !email || !hobbies || !password || !passwordConfirm) {
                    this.showToast('يرجى ملء جميع الحقول المطلوبة', 'error');
                    return;
                }

                // التحقق من تطابق كلمات المرور
                if (password !== passwordConfirm) {
                    this.showToast('كلمات المرور غير متطابقة', 'error');
                    return;
                }

                // التحقق من طول كلمة المرور
                if (password.length < 8) {
                    this.showToast('كلمة المرور يجب أن تكون 8 أحرف على الأقل', 'error');
                    return;
                }

                // التحقق من رقم الهوية
                if (!/^[1-2][0-9]{9}$/.test(nationalId)) {
                    this.showToast('يرجى إدخال رقم هوية صحيح (10 أرقام)', 'error');
                    return;
                }

                // التحقق من رقم الجوال
                if (!/^05\d{8}$/.test(phone)) {
                    this.showToast('يرجى إدخال رقم جوال صحيح بصيغة 05xxxxxxxx', 'error');
                    return;
                }

                // التحقق من البريد الإلكتروني
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    this.showToast('يرجى إدخال بريد إلكتروني صحيح', 'error');
                    return;
                }

                // التحقق من الموافقة على الشروط
                if (!agree) {
                    this.showToast('يرجى الموافقة على الشروط والأحكام', 'error');
                    return;
                }

                // إنشاء كائن البيانات
                const userData = {
                    first_name: firstName,
                    middle_name: middleName,
                    last_name: lastName,
                    full_name: `${firstName} ${middleName} ${lastName}`,
                    national_id: nationalId,
                    birth_date: birthDate,
                    birth_place: birthPlace,
                    father_id: fatherId,
                    generation: fatherId ? this.dataManager.calculateGeneration(fatherId) : 1,
                    profession: profession,
                    specialization: specialization,
                    phone: phone,
                    email: email,
                    hobbies: hobbies,
                    password: password
                };

                try {
                    const newUser = this.userManager.registerUser(userData);
                    this.showToast(`تم إرسال طلب التسجيل بنجاح! سيتم مراجعة طلبك من قبل الإدارة.`, 'success');
                    hideRegisterModal();
                } catch (error) {
                    this.showToast('خطأ في التسجيل: ' + error.message, 'error');
                }
            }

            refreshAllSections() {
                this.displayHomeStatistics();
                this.displayFamilyTree();
                this.displayEvents();
                this.displaySuggestions();
                this.displayLibrary();
                this.updateCharts();
            }

            // عرض الإحصائيات
            displayHomeStatistics() {
                const stats = {
                    members: this.dataManager.getData('familyMembers').length,
                    events: this.dataManager.getData('events').length,
                    suggestions: this.dataManager.getData('suggestions').length,
                    library: this.dataManager.getData('library').length
                };

                // إحصائيات إضافية
                const familyMembers = this.dataManager.getData('familyMembers');
                const generations = new Set(familyMembers.map(m => m.generation || 1)).size;
                const boardMembers = familyMembers.filter(m => 
                    ['founder', 'chairman', 'board_member'].includes(m.membership_type)
                ).length;
                
                const events = this.dataManager.getData('events');
                const activeEvents = events.filter(e => e.status === 'upcoming').length;
                
                const suggestions = this.dataManager.getData('suggestions');
                const approvedSuggestions = suggestions.filter(s => s.status === 'approved').length;

                // تحديث العدادات
                this.updateCounter('total-members', stats.members);
                this.updateCounter('total-events', stats.events);
                this.updateCounter('total-suggestions', stats.suggestions);
                this.updateCounter('total-library', stats.library);
                this.updateCounter('total-generations', generations);
                this.updateCounter('board-members', boardMembers);
                this.updateCounter('active-events', activeEvents);
                this.updateCounter('approved-suggestions', approvedSuggestions);
            }

            updateCounter(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    // تأثير العد التصاعدي
                    const current = parseInt(element.textContent) || 0;
                    const increment = Math.ceil((value - current) / 10);
                    let counter = current;
                    
                    const timer = setInterval(() => {
                        counter += increment;
                        if (counter >= value) {
                            counter = value;
                            clearInterval(timer);
                        }
                        element.textContent = counter;
                    }, 50);
                }
            }

            // عرض الشجرة العائلية المحسنة
            displayFamilyTree() {
                const familyMembers = this.dataManager.getData('familyMembers');
                const container = document.getElementById('family-tree');
                if (!container) return;

                // تحديث حالة البيانات
                this.updateDataStatus(familyMembers);

                if (familyMembers.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl text-white mb-4 opacity-50">
                                <i class="fas fa-sitemap"></i>
                            </div>
                            <p class="text-white text-xl mb-6">لا توجد شجرة عائلية</p>
                            <button onclick="loadSampleData()" class="bg-amber-600 text-white px-8 py-4 rounded-lg hover:bg-amber-700 text-lg">
                                <i class="fas fa-database ml-2"></i>تحميل البيانات الأساسية
                            </button>
                        </div>
                    `;
                    return;
                }

                // تجميع حسب الأجيال
                const generations = {};
                familyMembers.forEach(member => {
                    const gen = member.generation || 1;
                    if (!generations[gen]) generations[gen] = [];
                    generations[gen].push(member);
                });

                // عرض الأجيال
                container.innerHTML = Object.keys(generations)
                    .sort((a, b) => parseInt(a) - parseInt(b))
                    .map(gen => {
                        const genMembers = generations[gen];
                        const isFounderGen = gen == '1';
                        
                        return `
                            <div class="generation">
                                <div class="generation-header">
                                    <i class="fas ${isFounderGen ? 'fa-crown' : 'fa-users'} ml-2"></i>
                                    ${isFounderGen ? 'الجيل المؤسس' : `الجيل ${this.getGenerationName(gen)}`}
                                    <span class="bg-white text-blue-600 px-3 py-1 rounded-full mr-3 font-bold">
                                        ${genMembers.length} ${genMembers.length === 1 ? 'فرد' : 'أفراد'}
                                    </span>
                                </div>
                                
                                ${genMembers.map(member => this.renderMemberCard(member, !isFounderGen)).join('')}
                            </div>
                        `;
                    }).join('');
            }

            renderMemberCard(member, showConnection = false) {
                const father = member.father_id ? 
                    this.dataManager.getData('familyMembers').find(m => m.id === member.father_id) : null;
                const spouse = member.spouse_id ? 
                    this.dataManager.getData('familyMembers').find(m => m.id === member.spouse_id) : null;
                const childrenCount = member.children ? member.children.length : 0;
                
                return `
                    <div class="member-card ${member.membership_type === 'founder' ? 'founder-card' : ''} ${showConnection ? 'connection-line' : ''}">
                        <div class="card p-6 relative group">
                            <div class="member-actions">
                                <button onclick="editFamilyMember('${member.id}')" class="edit-btn" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteFamilyMember('${member.id}')" class="delete-btn" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-16 h-16 bg-gradient-to-br ${member.membership_type === 'founder' ? 'from-amber-400 to-orange-500' : 'from-blue-400 to-blue-600'} rounded-full flex items-center justify-center text-white text-xl font-bold mr-4 shadow-lg">
                                    ${member.full_name.charAt(0)}
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-lg font-bold text-gray-800 mb-2">
                                        ${member.full_name}
                                        <span class="text-sm ${member.gender === 'male' ? 'text-blue-500' : 'text-pink-500'} mr-2">
                                            <i class="fas ${member.gender === 'male' ? 'fa-mars' : 'fa-venus'}"></i>
                                        </span>
                                    </h4>
                                    
                                    ${father ? `
                                        <p class="text-gray-600 text-sm mb-2">
                                            <i class="fas fa-arrow-up ml-2 text-blue-500"></i>
                                            ${member.gender === 'male' ? 'ابن' : 'ابنة'} ${father.full_name}
                                        </p>
                                    ` : ''}
                                    
                                    ${spouse ? `
                                        <p class="text-purple-600 text-sm mb-2">
                                            <i class="fas fa-ring ml-2 text-purple-500"></i>
                                            ${member.gender === 'male' ? 'متزوج من' : 'متزوجة من'} ${spouse.full_name}
                                        </p>
                                    ` : ''}
                                    
                                    <span class="inline-block px-3 py-1 text-xs rounded-full ${this.getMembershipTypeColor(member.membership_type)} mb-2">
                                        ${this.getMembershipTypeText(member.membership_type)}
                                    </span>
                                    
                                    ${childrenCount > 0 ? `
                                        <p class="text-green-600 text-sm mb-2">
                                            <i class="fas fa-arrow-down ml-2"></i>
                                            ${childrenCount} ${childrenCount === 1 ? 'طفل' : 'أطفال'}
                                        </p>
                                    ` : ''}
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-gray-500 mt-3">
                                        ${member.birth_date ? `<div><i class="fas fa-birthday-cake ml-2 text-pink-500"></i>${new Date(member.birth_date).toLocaleDateString('ar-SA')}</div>` : ''}
                                        ${member.birth_place ? `<div><i class="fas fa-map-marker-alt ml-2 text-red-500"></i>${member.birth_place}</div>` : ''}
                                        ${member.profession ? `<div><i class="fas fa-briefcase ml-2 text-blue-500"></i>${member.profession}</div>` : ''}
                                        ${member.specialization ? `<div><i class="fas fa-graduation-cap ml-2 text-green-500"></i>${member.specialization}</div>` : ''}
                                        ${member.phone ? `<div><i class="fas fa-phone ml-2 text-indigo-500"></i>${member.phone}</div>` : ''}
                                        ${member.email ? `<div><i class="fas fa-envelope ml-2 text-purple-500"></i>${member.email}</div>` : ''}
                                    </div>
                                    ${member.hobbies ? `
                                        <div class="mt-3 p-2 bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg border border-amber-200">
                                            <div class="text-xs text-amber-700">
                                                <i class="fas fa-heart ml-2"></i>
                                                <strong>الهوايات:</strong> ${member.hobbies}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getGenerationName(genNum) {
                const names = {
                    '2': 'الثاني (الأطفال)',
                    '3': 'الثالث (الأحفاد)', 
                    '4': 'الرابع (أطفال الأحفاد)',
                    '5': 'الخامس'
                };
                return names[genNum] || `رقم ${genNum}`;
            }

            // مساعد للعائلة
            getMembershipTypeColor(type) {
                const colors = {
                    'founder': 'bg-amber-100 text-amber-700 border border-amber-200',
                    'chairman': 'bg-red-100 text-red-700 border border-red-200',
                    'board_member': 'bg-blue-100 text-blue-700 border border-blue-200',
                    'general_assembly': 'bg-green-100 text-green-700 border border-green-200',
                    'family_member': 'bg-gray-100 text-gray-700 border border-gray-200',
                    'honorary': 'bg-purple-100 text-purple-700 border border-purple-200'
                };
                return colors[type] || 'bg-gray-100 text-gray-700';
            }

            getMembershipTypeText(type) {
                const texts = {
                    'founder': '👑 المؤسس',
                    'chairman': '🎖️ رئيس مجلس الإدارة',
                    'board_member': '👔 عضو مجلس الإدارة',
                    'general_assembly': '👥 عضو الجمعية العمومية',
                    'family_member': '👨‍👩‍👧‍👦 عضو عائلة',
                    'honorary': '🏅 عضو شرفي'
                };
                return texts[type] || type;
            }

            // تحديث حالة البيانات
            updateDataStatus(familyMembers) {
                const memberCountDisplay = document.getElementById('member-count-display');
                const generationCountDisplay = document.getElementById('generation-count-display');
                
                if (memberCountDisplay && generationCountDisplay) {
                    const totalMembers = familyMembers.length;
                    const generations = new Set(familyMembers.map(m => m.generation || 1));
                    const secondGenCount = familyMembers.filter(m => m.generation === 2).length;
                    
                    memberCountDisplay.textContent = `📊 إجمالي الأعضاء: ${totalMembers}`;
                    generationCountDisplay.innerHTML = `🌳 الأجيال: ${generations.size} <span class="text-green-600 mr-2">| الجيل الثاني: ${secondGenCount} أعضاء</span>`;
                    
                    // تسجيل تفصيلي في الكونسول
                    if (secondGenCount > 0) {
                        console.log(`✅ تأكيد استرجاع الجيل الثاني: ${secondGenCount} أعضاء من أصل ${totalMembers}`);
                    }
                }
            }

            // نموذج العائلة
            showFamilyModal(memberId = null) {
                const modal = document.getElementById('familyModal');
                const title = document.getElementById('familyModalTitle');
                const form = document.getElementById('familyForm');
                
                if (memberId) {
                    // تعديل عضو موجود
                    const member = this.dataManager.getData('familyMembers').find(m => m.id === memberId);
                    if (member) {
                        title.textContent = 'تعديل بيانات العضو';
                        this.fillFamilyForm(member);
                    }
                } else {
                    // إضافة عضو جديد
                    title.textContent = 'إضافة عضو جديد للعائلة';
                    form.reset();
                }
                
                this.populateParentSelect();
                modal.classList.remove('hidden');
                
                // التركيز على أول حقل
                setTimeout(() => {
                    document.getElementById('familyFullName').focus();
                }, 100);
            }

            populateParentSelect() {
                // قائمة الوالدين (الذكور فقط)
                const fatherSelect = document.getElementById('familyFatherId');
                fatherSelect.innerHTML = '<option value="">-- اختر الوالد --</option>';
                
                const maleMembers = this.dataManager.getData('familyMembers').filter(m => m.gender === 'male');
                
                // تجميع حسب الأجيال
                const generations = {};
                maleMembers.forEach(member => {
                    const gen = member.generation || 1;
                    if (!generations[gen]) generations[gen] = [];
                    generations[gen].push(member);
                });
                
                // إضافة الخيارات مجموعة حسب الأجيال
                Object.keys(generations).sort((a, b) => parseInt(a) - parseInt(b)).forEach(genNum => {
                    const genGroup = document.createElement('optgroup');
                    genGroup.label = `${genNum == '1' ? 'الجيل المؤسس' : 'الجيل ' + genNum}`;
                    
                    generations[genNum].forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = `${member.full_name} (${this.getMembershipTypeText(member.membership_type).replace(/[🎖️👔👥👨‍👩‍👧‍👦🏅👑]/g, '').trim()})`;
                        genGroup.appendChild(option);
                    });
                    
                    fatherSelect.appendChild(genGroup);
                });

                // قائمة الأزواج (جميع الأعضاء)
                this.populateSpouseSelect();
            }

            populateSpouseSelect() {
                const spouseSelect = document.getElementById('familySpouseId');
                if (!spouseSelect) return;
                
                spouseSelect.innerHTML = '<option value="">-- اختر الزوج/الزوجة --</option>';
                
                const allMembers = this.dataManager.getData('familyMembers');
                
                // تجميع حسب الأجيال
                const generations = {};
                allMembers.forEach(member => {
                    const gen = member.generation || 1;
                    if (!generations[gen]) generations[gen] = [];
                    generations[gen].push(member);
                });
                
                // إضافة الخيارات مجموعة حسب الأجيال
                Object.keys(generations).sort((a, b) => parseInt(a) - parseInt(b)).forEach(genNum => {
                    const genGroup = document.createElement('optgroup');
                    genGroup.label = `${genNum == '1' ? 'الجيل المؤسس' : 'الجيل ' + genNum}`;
                    
                    generations[genNum].forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        const genderIcon = member.gender === 'male' ? '♂️' : '♀️';
                        option.textContent = `${genderIcon} ${member.full_name}`;
                        genGroup.appendChild(option);
                    });
                    
                    spouseSelect.appendChild(genGroup);
                });
            }

            fillFamilyForm(member) {
                // تحليل الاسم الكامل
                const nameParts = (member.full_name || '').split(' ');
                document.getElementById('familyFirstName').value = nameParts[0] || '';
                document.getElementById('familyMiddleName').value = nameParts[1] || '';
                document.getElementById('familyLastName').value = nameParts.slice(2).join(' ') || '';
                
                // باقي البيانات
                document.getElementById('familyFatherId').value = member.father_id || '';
                document.getElementById('familySpouseId').value = member.spouse_id || '';
                document.getElementById('familyMembershipType').value = member.membership_type || '';
                document.getElementById('familyGender').value = member.gender || '';
                document.getElementById('familyBirthDate').value = member.birth_date || '';
                document.getElementById('familyBirthPlace').value = member.birth_place || '';
                document.getElementById('familyProfession').value = member.profession || '';
                document.getElementById('familySpecialization').value = member.specialization || '';
                document.getElementById('familyPhone').value = member.phone || '';
                document.getElementById('familyEmail').value = member.email || '';
                document.getElementById('familyHobbies').value = member.hobbies || '';
                
                // تحديث المعاينة والجيل
                this.updateFullNamePreview();
                this.updateGenerationDisplay();
                
                // حفظ ID للتعديل
                document.getElementById('familyForm').dataset.editId = member.id;
            }

            saveFamilyMember() {
                const form = document.getElementById('familyForm');
                const editId = form.dataset.editId;
                
                // تجميع بيانات الاسم
                const firstName = document.getElementById('familyFirstName').value.trim();
                const middleName = document.getElementById('familyMiddleName').value.trim();
                const lastName = document.getElementById('familyLastName').value.trim();
                
                let fullName = firstName;
                if (middleName) fullName += ` ${middleName}`;
                if (lastName) fullName += ` ${lastName}`;
                
                const memberData = {
                    full_name: fullName,
                    first_name: firstName,
                    middle_name: middleName,
                    last_name: lastName,
                    father_id: document.getElementById('familyFatherId').value || null,
                    spouse_id: document.getElementById('familySpouseId').value || null,
                    membership_type: document.getElementById('familyMembershipType').value,
                    gender: document.getElementById('familyGender').value,
                    birth_date: document.getElementById('familyBirthDate').value || null,
                    birth_place: document.getElementById('familyBirthPlace').value.trim(),
                    profession: document.getElementById('familyProfession').value.trim(),
                    specialization: document.getElementById('familySpecialization').value.trim(),
                    phone: document.getElementById('familyPhone').value.trim(),
                    email: document.getElementById('familyEmail').value.trim(),
                    hobbies: document.getElementById('familyHobbies').value.trim()
                };
                
                // التحقق من البيانات المطلوبة
                if (!firstName || !lastName || !memberData.membership_type || !memberData.gender) {
                    this.showToast('يرجى ملء جميع الحقول المطلوبة: الاسم الأول، اسم العائلة، نوع العضوية، والجنس', 'error');
                    return;
                }

                // التحقق من صحة رقم الجوال (إذا تم إدخاله)
                if (memberData.phone && !/^05\d{8}$/.test(memberData.phone)) {
                    this.showToast('يرجى إدخال رقم جوال صحيح بصيغة 05xxxxxxxx', 'error');
                    return;
                }

                // التحقق من صحة البريد الإلكتروني (إذا تم إدخاله)
                if (memberData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(memberData.email)) {
                    this.showToast('يرجى إدخال بريد إلكتروني صحيح', 'error');
                    return;
                }
                
                try {
                    if (editId) {
                        // تعديل عضو موجود
                        this.dataManager.updateItem('familyMembers', editId, memberData);
                        this.showToast('تم تحديث بيانات العضو بنجاح', 'success');
                    } else {
                        // إضافة عضو جديد
                        const newMember = this.dataManager.addItem('familyMembers', memberData);
                        this.showToast(`تم إضافة ${memberData.full_name} للجيل ${newMember.generation} بنجاح!`, 'success');
                    }
                    
                    this.hideFamilyModal();
                    delete form.dataset.editId;
                    
                } catch (error) {
                    this.showToast('حدث خطأ: ' + error.message, 'error');
                }
            }

            hideFamilyModal() {
                document.getElementById('familyModal').classList.add('hidden');
                document.getElementById('familyForm').reset();
                this.updateFullNamePreview();
                this.updateGenerationDisplay();
            }

            resetFamilyForm() {
                if (confirm('هل أنت متأكد من إعادة تعيين جميع البيانات؟')) {
                    document.getElementById('familyForm').reset();
                    delete document.getElementById('familyForm').dataset.editId;
                    this.updateFullNamePreview();
                    this.updateGenerationDisplay();
                    this.showToast('تم إعادة تعيين النموذج', 'warning');
                }
            }

            // وظائف الأحداث والأقسام الأخرى (مبسطة)
            displayEvents() {
                const events = this.dataManager.getData('events');
                const container = document.getElementById('events-grid');
                if (!container) return;

                if (events.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl text-white mb-4 opacity-50">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <p class="text-white text-xl mb-4">لا توجد أحداث</p>
                            <button onclick="loadSampleData()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                                تحميل بيانات نموذجية
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = events.map(event => `
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3">${event.title}</h3>
                        <p class="text-gray-600 mb-4">${event.description}</p>
                        <div class="space-y-2 text-sm text-gray-500">
                            <div><i class="fas fa-calendar ml-2"></i>${event.date}</div>
                            <div><i class="fas fa-clock ml-2"></i>${event.time || 'غير محدد'}</div>
                            <div><i class="fas fa-map-marker-alt ml-2"></i>${event.location}</div>
                            <div><i class="fas fa-users ml-2"></i>${event.attendees || 0} مشارك</div>
                        </div>
                    </div>
                `).join('');
            }

            renderSuggestions() {
                const suggestions = this.dataManager.getData('suggestions');
                const container = document.getElementById('suggestions-grid');
                if (!container) return;

                if (suggestions.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl text-white mb-4 opacity-50">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <p class="text-white text-xl mb-4">لا توجد اقتراحات</p>
                            <button onclick="loadSampleData()" class="bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700">
                                تحميل بيانات نموذجية
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = suggestions.map(suggestion => this.renderSuggestionCard(suggestion)).join('');
                this.updateSuggestionsStats();
            }

            renderSuggestionCard(suggestion) {
                const statusBadges = {
                    'pending': '<span class="px-2 py-1 text-xs bg-yellow-100 text-yellow-700 rounded-full">⏳ قيد المراجعة</span>',
                    'approved': '<span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full">✅ مقبول</span>',
                    'rejected': '<span class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded-full">❌ مرفوض</span>',
                    'under_review': '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-full">🔍 تحت المراجعة</span>'
                };

                const priorityColors = {
                    'low': 'text-green-600',
                    'medium': 'text-yellow-600', 
                    'high': 'text-red-600',
                    'urgent': 'text-red-800'
                };

                const categoryIcons = {
                    'technology': '🔧',
                    'events': '🎉',
                    'services': '🛎️',
                    'education': '📚',
                    'social': '👥',
                    'business': '💼',
                    'other': '📝'
                };

                const isAdmin = this.userManager.currentUser && this.userManager.currentUser.role === 'admin';

                return `
                    <div class="card p-6 hover:shadow-lg transition-shadow">
                        <!-- Header -->
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">${suggestion.title}</h3>
                                <div class="flex items-center gap-2 text-sm text-gray-600">
                                    <span class="${priorityColors[suggestion.priority]}">
                                        ${categoryIcons[suggestion.category]} ${this.getCategoryText(suggestion.category)}
                                    </span>
                                    • 
                                    <span>بواسطة ${suggestion.submitted_by}</span>
                                    • 
                                    <span>${suggestion.submitted_date}</span>
                                </div>
                            </div>
                            ${statusBadges[suggestion.status] || ''}
                        </div>

                        <!-- Description -->
                        <p class="text-gray-700 mb-4 line-clamp-3">${suggestion.description}</p>

                        <!-- Benefits -->
                        ${suggestion.benefits ? `
                            <div class="mb-4">
                                <h5 class="text-sm font-semibold text-gray-800 mb-2">الفوائد المتوقعة:</h5>
                                <p class="text-sm text-gray-600">${suggestion.benefits}</p>
                            </div>
                        ` : ''}

                        <!-- Budget and Timeline -->
                        ${suggestion.budget || suggestion.timeline ? `
                            <div class="grid grid-cols-2 gap-4 mb-4 p-3 bg-gray-50 rounded-lg">
                                ${suggestion.budget ? `<div><span class="text-sm font-medium">الميزانية:</span> <span class="text-sm text-gray-600">${suggestion.budget}</span></div>` : ''}
                                ${suggestion.timeline ? `<div><span class="text-sm font-medium">المدة:</span> <span class="text-sm text-gray-600">${suggestion.timeline}</span></div>` : ''}
                            </div>
                        ` : ''}

                        <!-- Voting and Actions -->
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4 rtl:space-x-reverse">
                                <button onclick="voteSuggestion('${suggestion.id}', 'up')" class="flex items-center text-green-600 hover:text-green-700 transition">
                                    <i class="fas fa-thumbs-up ml-1"></i>
                                    <span>${suggestion.votes.up}</span>
                                </button>
                                <button onclick="voteSuggestion('${suggestion.id}', 'down')" class="flex items-center text-red-600 hover:text-red-700 transition">
                                    <i class="fas fa-thumbs-down ml-1"></i>
                                    <span>${suggestion.votes.down}</span>
                                </button>
                                <span class="text-gray-500">
                                    <i class="fas fa-comments ml-1"></i>
                                    ${suggestion.comments.length}
                                </span>
                            </div>

                            <!-- Admin Actions -->
                            ${isAdmin ? `
                                <div class="flex gap-2">
                                    ${suggestion.status === 'pending' ? `
                                        <button onclick="updateSuggestionStatus('${suggestion.id}', 'approved')" class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200">
                                            قبول
                                        </button>
                                        <button onclick="updateSuggestionStatus('${suggestion.id}', 'rejected')" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">
                                            رفض
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            getCategoryText(category) {
                const categories = {
                    'technology': 'تقني',
                    'events': 'فعاليات',
                    'services': 'خدمات',
                    'education': 'تعليمي',
                    'social': 'اجتماعي',
                    'business': 'تجاري',
                    'other': 'أخرى'
                };
                return categories[category] || category;
            }

            renderLibrary() {
                const library = this.dataManager.getData('library');
                const container = document.getElementById('library-grid');
                if (!container) return;

                if (library.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl text-white mb-4 opacity-50">
                                <i class="fas fa-book"></i>
                            </div>
                            <p class="text-white text-xl mb-4">لا توجد محتويات في المكتبة</p>
                            <button onclick="loadSampleData()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700">
                                تحميل بيانات نموذجية
                            </button>
                        </div>
                    `;
                    return;
                }

                // فرز المحتوى: المميز أولاً، ثم حسب التاريخ
                const sortedLibrary = library.sort((a, b) => {
                    if (a.featured && !b.featured) return -1;
                    if (!a.featured && b.featured) return 1;
                    return new Date(b.created_date) - new Date(a.created_date);
                });

                container.innerHTML = sortedLibrary.map(item => this.renderLibraryCard(item)).join('');
                this.updateLibraryStats();
            }

            renderLibraryCard(item) {
                const typeIcons = {
                    'document': '📄',
                    'book': '📚',
                    'article': '📝',
                    'video': '🎥',
                    'audio': '🎵',
                    'image': '🖼️',
                    'presentation': '📊',
                    'research': '🔬'
                };

                const categoryTexts = {
                    'family_history': 'تاريخ العائلة',
                    'genealogy': 'الأنساب',
                    'documents': 'الوثائق الرسمية',
                    'photos': 'الصور والذكريات',
                    'achievements': 'الإنجازات',
                    'stories': 'القصص والحكايات',
                    'education': 'التعليم والمهارات',
                    'business': 'الأعمال والتجارة'
                };

                const accessBadges = {
                    'public': '<span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full">🌍 عام</span>',
                    'family': '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-full">👨‍👩‍👧‍👦 عائلي</span>',
                    'admin': '<span class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded-full">🔒 إداري</span>'
                };

                const canAccess = this.checkLibraryAccess(item);

                return `
                    <div class="card p-6 hover:shadow-lg transition-shadow ${item.featured ? 'ring-2 ring-yellow-400' : ''}">
                        <!-- Featured Badge -->
                        ${item.featured ? '<div class="absolute -top-2 -right-2 bg-yellow-400 text-yellow-900 px-2 py-1 rounded-full text-xs font-bold">⭐ مميز</div>' : ''}
                        
                        <!-- Header -->
                        <div class="flex items-start gap-3 mb-4">
                            <div class="text-3xl">${typeIcons[item.type] || '📄'}</div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-1">${item.title}</h3>
                                <p class="text-sm text-gray-600">بقلم: ${item.author}</p>
                                <p class="text-xs text-gray-500">${item.created_date}</p>
                            </div>
                        </div>

                        <!-- Description -->
                        <p class="text-gray-700 mb-4 line-clamp-3">${item.description}</p>

                        <!-- Keywords -->
                        ${item.keywords && item.keywords.length > 0 ? `
                            <div class="flex flex-wrap gap-1 mb-4">
                                ${item.keywords.map(keyword => `
                                    <span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">${keyword}</span>
                                `).join('')}
                            </div>
                        ` : ''}

                        <!-- Category and Access -->
                        <div class="flex justify-between items-center mb-4">
                            <span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-700">
                                ${categoryTexts[item.category] || item.category}
                            </span>
                            ${accessBadges[item.access_level] || ''}
                        </div>

                        <!-- Stats and Actions -->
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-4 text-sm text-gray-500">
                                <span><i class="fas fa-eye ml-1"></i>${item.views || 0}</span>
                                <span><i class="fas fa-download ml-1"></i>${item.downloads || 0}</span>
                                <span><i class="fas fa-globe ml-1"></i>${item.language === 'arabic' ? 'العربية' : item.language}</span>
                            </div>

                            <div class="flex gap-2">
                                ${canAccess ? `
                                    ${item.url && item.url !== '#' ? `
                                        <button onclick="openLibraryItem('${item.id}')" class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition">
                                            <i class="fas fa-external-link-alt ml-1"></i>فتح
                                        </button>
                                    ` : ''}
                                    <button onclick="downloadLibraryItem('${item.id}')" class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition">
                                        <i class="fas fa-download ml-1"></i>تحميل
                                    </button>
                                ` : `
                                    <span class="px-3 py-1 text-xs bg-gray-100 text-gray-500 rounded">غير متاح</span>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }

            checkLibraryAccess(item) {
                if (item.access_level === 'public') return true;
                if (!this.userManager.currentUser) return false;
                if (item.access_level === 'family') return true;
                if (item.access_level === 'admin') return this.userManager.currentUser.role === 'admin';
                return false;
            }

            updateLibraryStats() {
                const library = this.dataManager.getData('library');
                
                // حساب الإحصائيات
                const totalItems = library.length;
                const featuredItems = library.filter(item => item.featured).length;
                const totalViews = library.reduce((sum, item) => sum + (item.views || 0), 0);
                const totalDownloads = library.reduce((sum, item) => sum + (item.downloads || 0), 0);

                // تحديث العناصر في الواجهة
                const totalElement = document.getElementById('library-total-items');
                const featuredElement = document.getElementById('library-featured-items');
                const viewsElement = document.getElementById('library-total-views');
                const downloadsElement = document.getElementById('library-total-downloads');

                if (totalElement) totalElement.textContent = totalItems;
                if (featuredElement) featuredElement.textContent = featuredItems;
                if (viewsElement) viewsElement.textContent = totalViews;
                if (downloadsElement) downloadsElement.textContent = totalDownloads;
            }

            updateSuggestionsStats() {
                const suggestions = this.dataManager.getData('suggestions');
                
                // حساب الإحصائيات
                const totalSuggestions = suggestions.length;
                const pendingSuggestions = suggestions.filter(item => item.status === 'pending').length;
                const approvedSuggestions = suggestions.filter(item => item.status === 'approved').length;
                const highPrioritySuggestions = suggestions.filter(item => item.priority === 'high' || item.priority === 'urgent').length;

                // تحديث العناصر في الواجهة
                const totalElement = document.getElementById('suggestions-total');
                const pendingElement = document.getElementById('suggestions-pending');
                const approvedElement = document.getElementById('suggestions-approved');
                const highPriorityElement = document.getElementById('suggestions-high-priority');

                if (totalElement) totalElement.textContent = totalSuggestions;
                if (pendingElement) pendingElement.textContent = pendingSuggestions;
                if (approvedElement) approvedElement.textContent = approvedSuggestions;
                if (highPriorityElement) highPriorityElement.textContent = highPrioritySuggestions;
            }

            // الرسوم البيانية
            initializeCharts() {
                this.createMembershipChart();
                this.createActivityChart();
            }

            createMembershipChart() {
                const ctx = document.getElementById('membershipChart');
                if (!ctx) return;

                const familyMembers = this.dataManager.getData('familyMembers');
                const membershipData = {};
                
                familyMembers.forEach(member => {
                    const type = this.getMembershipTypeText(member.membership_type).replace(/[🎖️👔👥👨‍👩‍👧‍👦🏅👑]/g, '').trim();
                    membershipData[type] = (membershipData[type] || 0) + 1;
                });

                if (this.charts.membership) {
                    this.charts.membership.destroy();
                }

                this.charts.membership = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(membershipData),
                        datasets: [{
                            data: Object.values(membershipData),
                            backgroundColor: [
                                '#fbbf24', // amber
                                '#ef4444', // red
                                '#3b82f6', // blue
                                '#10b981', // green
                                '#6b7280', // gray
                                '#8b5cf6'  // purple
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 1.2,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            createActivityChart() {
                const ctx = document.getElementById('activityChart');
                if (!ctx) return;

                // بيانات نموذجية للنشاط الشهري
                const monthlyData = [12, 19, 15, 22, 28, 18, 25, 20, 16, 24, 30, 22];
                const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                              'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];

                if (this.charts.activity) {
                    this.charts.activity.destroy();
                }

                this.charts.activity = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'النشاط الشهري',
                            data: monthlyData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 1.8,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
            }

            updateCharts() {
                this.createMembershipChart();
                // لا حاجة لتحديث رسم النشاط لأنه يحتوي على بيانات ثابتة
            }

            // وظائف مساعدة
            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 300);
                }, 4000);
            }

            // إنشاء النماذج (مبسط)
            createModals() {
                // تتم إضافة النماذج في HTML
            }

            // تحميل البيانات النموذجية
            loadSampleData() {
                try {
                    this.dataManager.loadSampleData();
                    
                    // التحقق من البيانات المحملة
                    const totalMembers = this.dataManager.getData('familyMembers').length;
                    const secondGen = this.dataManager.getData('familyMembers').filter(m => m.generation === 2);
                    
                    this.showToast(
                        `✅ تم تحميل البيانات النموذجية بنجاح!\n🌳 إجمالي الأعضاء: ${totalMembers}\n👥 الجيل الثاني: ${secondGen.length} أعضاء`, 
                        'success'
                    );
                    
                    this.refreshAllSections();
                    
                    // التبديل إلى قسم الشجرة العائلية لإظهار النتائج
                    setTimeout(() => {
                        showSection('family');
                    }, 1500);
                    
                } catch (error) {
                    this.showToast('حدث خطأ أثناء تحميل البيانات: ' + error.message, 'error');
                }
            }
        }

        // المتغيرات العامة
        let app;

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            try {
                app = new EnhancedAlSaedanApp();
                console.log('✅ تم تحميل التطبيق الشامل المحسن بنجاح');
            } catch (error) {
                console.error('❌ خطأ في تهيئة التطبيق:', error);
            }
        });

        // وظائف التنقل
        function showSection(sectionName) {
            // إزالة الفئة النشطة من جميع الأقسام
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // إظهار القسم المطلوب
            const targetSection = document.getElementById(`${sectionName}-section`);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // تفعيل زر التنقل
            const navButton = document.getElementById(`nav-${sectionName}`);
            if (navButton) {
                navButton.classList.add('active');
            }

            // تحديث المحتوى حسب القسم
            if (app) {
                switch(sectionName) {
                    case 'home':
                        setTimeout(() => {
                            app.updateCharts();
                            app.updateStats();
                        }, 100);
                        break;
                    case 'family':
                        app.displayFamilyTree();
                        break;
                    case 'events':
                        app.displayEvents();
                        break;
                    case 'suggestions':
                        app.renderSuggestions();
                        break;
                    case 'library':
                        app.renderLibrary();
                        break;
                    case 'profile':
                        app.displayUserProfile();
                        break;
                    case 'admin':
                        if (app.userManager.currentUser && app.userManager.currentUser.role === 'admin') {
                            app.displayAdminPanel();
                        }
                        break;
                }
            }
        }

        // وظائف العائلة
        function loadFounderFamily() {
            if (app) {
                app.loadSampleData();
            }
        }

        function loadSampleData() {
            if (app) {
                app.loadSampleData();
            }
        }

        function showFamilyModal(memberId = null) {
            if (app) {
                app.showFamilyModal(memberId);
            }
        }

        function hideFamilyModal() {
            if (app) {
                app.hideFamilyModal();
            }
        }

        function resetFamilyForm() {
            if (app) {
                app.resetFamilyForm();
            }
        }

        function editFamilyMember(id) {
            if (app) {
                app.showFamilyModal(id);
            }
        }

        function deleteFamilyMember(id) {
            if (!app) return;
            
            if (confirm('هل أنت متأكد من حذف هذا العضو؟')) {
                try {
                    app.dataManager.deleteItem('familyMembers', id);
                    app.showToast('تم حذف العضو بنجاح', 'success');
                } catch (error) {
                    app.showToast('حدث خطأ: ' + error.message, 'error');
                }
            }
        }

        // وظائف النماذج الأخرى (مبسطة)
        function showEventModal() {
            alert('نموذج الأحداث - قريباً');
        }

        // وظائف إدارة الاقتراحات
        function showSuggestionModal() {
            document.getElementById('suggestionModal').classList.remove('hidden');
            document.getElementById('suggestionTitle').focus();
        }

        function hideSuggestionModal() {
            document.getElementById('suggestionModal').classList.add('hidden');
            document.getElementById('suggestionForm').reset();
        }

        function resetSuggestionForm() {
            document.getElementById('suggestionForm').reset();
            document.getElementById('suggestionTitle').focus();
        }

        function handleSuggestionSubmit(event) {
            event.preventDefault();
            
            if (!app.userManager.currentUser) {
                app.showToast('يجب تسجيل الدخول أولاً لإضافة اقتراح', 'error');
                return;
            }

            const formData = {
                title: document.getElementById('suggestionTitle').value,
                category: document.getElementById('suggestionCategory').value,
                priority: document.getElementById('suggestionPriority').value,
                description: document.getElementById('suggestionDescription').value,
                benefits: document.getElementById('suggestionBenefits').value,
                budget: document.getElementById('suggestionBudget').value,
                timeline: document.getElementById('suggestionTimeline').value,
                resources: document.getElementById('suggestionResources').value
            };

            const suggestion = {
                id: 'sugg_' + Date.now(),
                ...formData,
                status: 'pending',
                submitted_by: app.userManager.currentUser.first_name + ' ' + app.userManager.currentUser.last_name,
                submitted_date: new Date().toISOString().split('T')[0],
                votes: { up: 0, down: 0 },
                comments: []
            };

            const suggestions = app.dataManager.getData('suggestions');
            suggestions.push(suggestion);
            app.dataManager.setData('suggestions', suggestions);
            
            app.showToast('تم إرسال الاقتراح بنجاح!', 'success');
            hideSuggestionModal();
            app.renderSuggestions();
            app.updateStats();
        }

        // وظائف إدارة المكتبة الرقمية
        function showLibraryModal() {
            document.getElementById('libraryModal').classList.remove('hidden');
            document.getElementById('libraryTitle').focus();
        }

        function hideLibraryModal() {
            document.getElementById('libraryModal').classList.add('hidden');
            document.getElementById('libraryForm').reset();
        }

        function resetLibraryForm() {
            document.getElementById('libraryForm').reset();
            document.getElementById('libraryTitle').focus();
        }

        function handleLibrarySubmit(event) {
            event.preventDefault();
            
            if (!app.userManager.currentUser) {
                app.showToast('يجب تسجيل الدخول أولاً لإضافة محتوى للمكتبة', 'error');
                return;
            }

            const formData = {
                title: document.getElementById('libraryTitle').value,
                type: document.getElementById('libraryType').value,
                category: document.getElementById('libraryCategory').value,
                author: document.getElementById('libraryAuthor').value || (app.userManager.currentUser.first_name + ' ' + app.userManager.currentUser.last_name),
                description: document.getElementById('libraryDescription').value,
                keywords: document.getElementById('libraryKeywords').value.split(',').map(k => k.trim()).filter(k => k),
                created_date: document.getElementById('libraryDate').value || new Date().toISOString().split('T')[0],
                language: document.getElementById('libraryLanguage').value,
                url: document.getElementById('libraryUrl').value,
                access_level: document.getElementById('libraryAccess').value,
                featured: document.getElementById('libraryFeatured').checked
            };

            const libraryItem = {
                id: 'lib_' + Date.now(),
                ...formData,
                views: 0,
                downloads: 0,
                added_by: app.userManager.currentUser.email,
                added_date: new Date().toISOString().split('T')[0]
            };

            const library = app.dataManager.getData('library');
            library.push(libraryItem);
            app.dataManager.setData('library', library);
            
            app.showToast('تم إضافة المحتوى للمكتبة بنجاح!', 'success');
            hideLibraryModal();
            app.renderLibrary();
            app.updateStats();
        }

        // وظائف التفاعل مع الاقتراحات
        function voteSuggestion(suggestionId, voteType) {
            if (!app.userManager.currentUser) {
                app.showToast('يجب تسجيل الدخول للتصويت', 'error');
                return;
            }

            const suggestions = app.dataManager.getData('suggestions');
            const suggestion = suggestions.find(s => s.id === suggestionId);
            
            if (suggestion) {
                if (voteType === 'up') {
                    suggestion.votes.up++;
                    app.showToast('تم تسجيل صوتك مع الاقتراح', 'success');
                } else {
                    suggestion.votes.down++;
                    app.showToast('تم تسجيل صوتك ضد الاقتراح', 'warning');
                }
                
                app.dataManager.setData('suggestions', suggestions);
                app.renderSuggestions();
            }
        }

        function updateSuggestionStatus(suggestionId, newStatus) {
            if (!app.userManager.currentUser || app.userManager.currentUser.role !== 'admin') {
                app.showToast('غير مخول لتحديث حالة الاقتراحات', 'error');
                return;
            }

            const suggestions = app.dataManager.getData('suggestions');
            const suggestion = suggestions.find(s => s.id === suggestionId);
            
            if (suggestion) {
                suggestion.status = newStatus;
                app.dataManager.setData('suggestions', suggestions);
                app.renderSuggestions();
                app.showToast(`تم تحديث حالة الاقتراح إلى: ${newStatus}`, 'success');
            }
        }

        // وظائف التفاعل مع المكتبة الرقمية
        function openLibraryItem(itemId) {
            const library = app.dataManager.getData('library');
            const item = library.find(i => i.id === itemId);
            
            if (!item) return;

            // تسجيل المشاهدة
            item.views = (item.views || 0) + 1;
            app.dataManager.setData('library', library);
            
            if (item.url && item.url !== '#') {
                window.open(item.url, '_blank');
                app.showToast(`تم فتح: ${item.title}`, 'success');
                app.renderLibrary();
            } else {
                app.showToast('الرابط غير متوفر حالياً', 'warning');
            }
        }

        function downloadLibraryItem(itemId) {
            const library = app.dataManager.getData('library');
            const item = library.find(i => i.id === itemId);
            
            if (!item) return;

            // التحقق من صلاحية الوصول
            if (!app.checkLibraryAccess(item)) {
                app.showToast('ليس لديك صلاحية للوصول لهذا المحتوى', 'error');
                return;
            }

            // تسجيل التحميل
            item.downloads = (item.downloads || 0) + 1;
            app.dataManager.setData('library', library);
            
            if (item.url && item.url !== '#') {
                // محاولة تحميل الملف
                const link = document.createElement('a');
                link.href = item.url;
                link.download = item.title;
                link.click();
                
                app.showToast(`تم بدء تحميل: ${item.title}`, 'success');
                app.renderLibrary();
            } else {
                app.showToast('ملف التحميل غير متوفر حالياً', 'warning');
            }
        }

        function searchLibrary(query) {
            const library = app.dataManager.getData('library');
            const container = document.getElementById('library-grid');
            
            if (!query.trim()) {
                app.renderLibrary();
                return;
            }

            const filteredLibrary = library.filter(item => 
                item.title.toLowerCase().includes(query.toLowerCase()) ||
                item.description.toLowerCase().includes(query.toLowerCase()) ||
                item.author.toLowerCase().includes(query.toLowerCase()) ||
                (item.keywords && item.keywords.some(keyword => 
                    keyword.toLowerCase().includes(query.toLowerCase())
                ))
            );

            if (filteredLibrary.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl text-white mb-4 opacity-50">
                            <i class="fas fa-search"></i>
                        </div>
                        <p class="text-white text-xl mb-4">لم يتم العثور على نتائج للبحث: "${query}"</p>
                        <button onclick="app.renderLibrary()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                            عرض جميع المحتويات
                        </button>
                    </div>
                `;
            } else {
                container.innerHTML = filteredLibrary.map(item => app.renderLibraryCard(item)).join('');
            }
        }

        function filterLibraryByCategory(category) {
            const library = app.dataManager.getData('library');
            const container = document.getElementById('library-grid');
            
            if (!category || category === 'all') {
                app.renderLibrary();
                return;
            }

            const filteredLibrary = library.filter(item => item.category === category);
            container.innerHTML = filteredLibrary.map(item => app.renderLibraryCard(item)).join('');
        }

        // وظائف فلترة الاقتراحات
        function filterSuggestionsByStatus(status) {
            const suggestions = app.dataManager.getData('suggestions');
            const container = document.getElementById('suggestions-grid');
            
            if (!status || status === 'all') {
                app.renderSuggestions();
                return;
            }

            const filteredSuggestions = suggestions.filter(item => item.status === status);
            container.innerHTML = filteredSuggestions.map(item => app.renderSuggestionCard(item)).join('');
        }

        function filterSuggestionsByCategory(category) {
            const suggestions = app.dataManager.getData('suggestions');
            const container = document.getElementById('suggestions-grid');
            
            if (!category || category === 'all') {
                app.renderSuggestions();
                return;
            }

            const filteredSuggestions = suggestions.filter(item => item.category === category);
            container.innerHTML = filteredSuggestions.map(item => app.renderSuggestionCard(item)).join('');
        }

        function filterSuggestionsByPriority(priority) {
            const suggestions = app.dataManager.getData('suggestions');
            const container = document.getElementById('suggestions-grid');
            
            if (!priority || priority === 'all') {
                app.renderSuggestions();
                return;
            }

            const filteredSuggestions = suggestions.filter(item => item.priority === priority);
            container.innerHTML = filteredSuggestions.map(item => app.renderSuggestionCard(item)).join('');
        }

        // وظائف المصادقة والتسجيل
        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginIdentifier').focus();
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginForm').reset();
        }

        function showRegisterModal() {
            document.getElementById('registerModal').classList.remove('hidden');
            if (app) {
                app.populateRegisterParentSelect();
            }
            document.getElementById('registerFirstName').focus();
        }

        function hideRegisterModal() {
            document.getElementById('registerModal').classList.add('hidden');
            document.getElementById('registerForm').reset();
            updateRegisterFullNamePreview();
        }

        function resetRegisterForm() {
            if (confirm('هل أنت متأكد من إعادة تعيين جميع البيانات؟')) {
                document.getElementById('registerForm').reset();
                updateRegisterFullNamePreview();
                app?.showToast('تم إعادة تعيين النموذج', 'warning');
            }
        }

        // تحديث معاينة الاسم في نموذج التسجيل
        function updateRegisterFullNamePreview() {
            const firstName = document.getElementById('registerFirstName')?.value.trim() || '';
            const middleName = document.getElementById('registerMiddleName')?.value.trim() || '';
            const lastName = document.getElementById('registerLastName')?.value.trim() || '';
            
            let fullName = firstName;
            if (middleName) fullName += ` ${middleName}`;
            if (lastName) fullName += ` ${lastName}`;
            
            const preview = document.getElementById('registerFullNamePreview');
            if (preview) {
                preview.textContent = fullName || 'سيتم تكوين الاسم تلقائياً...';
            }
        }

        // وظائف الإدارة
        function approveUser(userId) {
            if (!app || !app.userManager.currentUser || app.userManager.currentUser.role !== 'admin') {
                alert('ليس لديك صلاحية لهذا الإجراء');
                return;
            }

            if (confirm('هل أنت متأكد من الموافقة على هذا المستخدم؟')) {
                try {
                    app.userManager.approveUser(userId, app.userManager.currentUser.id);
                    app.displayAdminPanel();
                    app.showToast('تم تفعيل المستخدم بنجاح', 'success');
                } catch (error) {
                    app.showToast('حدث خطأ: ' + error.message, 'error');
                }
            }
        }

        function rejectUser(userId) {
            if (!app || !app.userManager.currentUser || app.userManager.currentUser.role !== 'admin') {
                alert('ليس لديك صلاحية لهذا الإجراء');
                return;
            }

            if (confirm('هل أنت متأكد من رفض هذا المستخدم؟ سيتم حذف طلبه نهائياً.')) {
                try {
                    app.userManager.rejectUser(userId, app.userManager.currentUser.id);
                    app.displayAdminPanel();
                    app.showToast('تم رفض طلب التسجيل', 'warning');
                } catch (error) {
                    app.showToast('حدث خطأ: ' + error.message, 'error');
                }
            }
        }

        function refreshPendingUsers() {
            if (app) {
                app.displayAdminPanel();
                app.showToast('تم تحديث قائمة الطلبات', 'success');
            }
        }

        function editProfile() {
            if (app && app.userManager.currentUser) {
                // يمكن إضافة نموذج تعديل منفصل لاحقاً
                app.showToast('ميزة تعديل الملف الشخصي ستكون متاحة قريباً', 'warning');
            }
        }

        function logout() {
            if (app && confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                app.userManager.logout();
                app.updateAuthUI();
                showSection('home');
                app.showToast('تم تسجيل الخروج بنجاح', 'success');
            }
        }

        // دالة لإعادة تعيين المدير الافتراضي (للاستخدام في الكونسول)
        function resetDefaultAdmin() {
            if (app && app.userManager) {
                const admin = app.userManager.resetDefaultAdmin();
                console.log('تم إعادة تعيين المدير الافتراضي');
                app.showToast('تم إعادة تعيين المدير الافتراضي بنجاح', 'success');
                return admin;
            }
        }

        // دالة لعرض جميع المستخدمين (للتشخيص)
        function showAllUsers() {
            if (app && app.userManager) {
                console.log('📋 جميع المستخدمين:');
                app.userManager.users.forEach(u => {
                    console.log(`- ${u.full_name} (${u.email}) - ${u.role} - ${u.status}`);
                });
                return app.userManager.users;
            }
        }

        // وظيفة اختبار استرجاع بيانات الجيل الثاني
        function testSecondGenerationRetrieval() {
            if (!app) {
                alert('التطبيق غير مهيأ بعد');
                return;
            }

            try {
                console.log('🧪 اختبار استرجاع بيانات الجيل الثاني...');
                
                const allMembers = app.dataManager.getData('familyMembers');
                const firstGeneration = allMembers.filter(m => m.generation === 1);
                const secondGeneration = allMembers.filter(m => m.generation === 2);
                const thirdGeneration = allMembers.filter(m => m.generation === 3);

                let testResults = `🔍 نتائج اختبار استرجاع البيانات:\n\n`;
                testResults += `📊 إجمالي الأعضاء: ${allMembers.length}\n`;
                testResults += `👑 الجيل الأول (المؤسسين): ${firstGeneration.length}\n`;
                testResults += `👥 الجيل الثاني: ${secondGeneration.length}\n`;
                testResults += `👶 الجيل الثالث: ${thirdGeneration.length}\n\n`;

                if (secondGeneration.length > 0) {
                    testResults += `✅ تم العثور على الجيل الثاني بنجاح:\n`;
                    secondGeneration.forEach((member, index) => {
                        const father = allMembers.find(m => m.id === member.father_id);
                        testResults += `${index + 1}. ${member.full_name}\n`;
                        testResults += `   - الجيل: ${member.generation}\n`;
                        testResults += `   - الوالد: ${father ? father.full_name : 'غير محدد'}\n`;
                        testResults += `   - العضوية: ${app.getMembershipTypeText(member.membership_type)}\n\n`;
                    });
                    
                    // اختبار الروابط العائلية
                    testResults += `🔗 اختبار الروابط العائلية:\n`;
                    firstGeneration.forEach(founder => {
                        const children = allMembers.filter(m => m.father_id === founder.id);
                        testResults += `- ${founder.full_name}: ${children.length} من الأطفال\n`;
                    });

                    app.showToast('✅ اختبار الجيل الثاني نجح! راجع وحدة التحكم للتفاصيل.', 'success');
                } else {
                    testResults += `❌ لم يتم العثور على أعضاء في الجيل الثاني\n`;
                    testResults += `💡 تأكد من تحميل البيانات الأساسية أولاً`;
                    
                    app.showToast('⚠️ لم يتم العثور على الجيل الثاني. حمّل البيانات الأساسية أولاً.', 'warning');
                }

                console.log(testResults);
                alert(testResults);

            } catch (error) {
                const errorMsg = `❌ خطأ في اختبار استرجاع البيانات: ${error.message}`;
                console.error(errorMsg);
                app.showToast(errorMsg, 'error');
            }
        }

        // مستمعي الأحداث
        document.addEventListener('click', function(e) {
            if (e.target.id === 'familyModal') {
                hideFamilyModal();
            }
            if (e.target.id === 'loginModal') {
                hideLoginModal();
            }
            if (e.target.id === 'registerModal') {
                hideRegisterModal();
            }
        });
    </script>
</body>
</html>